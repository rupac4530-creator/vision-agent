<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vision Agent â€” Real-Time Multimodal AI</title>
    <meta name="description"
        content="Real-time multimodal AI video agent that watches, listens, and understands video. Powered by Vision Agents SDK." />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <style>
        /* â”€â”€ CSS Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.08);
            --border-active: rgba(99, 102, 241, 0.5);
            --text-primary: #f0f0f5;
            --text-secondary: #9ca3b0;
            --text-muted: #5a5f6e;
            --accent-1: #6366f1;
            --accent-2: #8b5cf6;
            --accent-3: #a855f7;
            --gradient-main: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
            --gradient-subtle: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 16px;
            --radius-sm: 10px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* â”€â”€ Cosmic Starfield Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #cosmicCanvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
        }

        /* â”€â”€ Page entrance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app {
            animation: appEntrance 0.8s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        @keyframes appEntrance {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* â”€â”€ Logo eye-blink animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .logo-eye {
            transform-origin: center;
            transition: transform 0.15s ease;
        }

        .logo.blink .logo-eye {
            transform: scaleY(0.05);
        }

        .logo svg {
            animation: logoEntrance 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            animation-delay: 0.3s;
        }

        @keyframes logoEntrance {
            from {
                transform: scale(0.6) rotate(-10deg);
                opacity: 0;
            }

            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .logo:hover svg {
            animation: logoPulse 0.5s ease;
        }

        @keyframes logoPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15) rotate(5deg);
            }
        }

        /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app {
            position: relative;
            z-index: 1;
        }

        .header {
            padding: 24px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            background: rgba(10, 10, 15, 0.7);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 800;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .badge {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--gradient-subtle);
            color: var(--accent-1);
            border: 1px solid var(--border-active);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        /* â”€â”€ Tab Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 32px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-card-hover);
            transform: translateY(-1px);
        }

        .tab:active {
            transform: scale(0.97);
        }

        .tab.active {
            color: #fff;
            background: var(--gradient-main);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            transform: translateY(0);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: panelEnter 0.35s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        @keyframes panelEnter {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            backdrop-filter: blur(12px);
            transition: var(--transition);
        }

        .card:hover {
            border-color: var(--border-active);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* â”€â”€ Drop Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dropzone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .dropzone:hover,
        .dropzone.dragover {
            border-color: var(--accent-1);
            background: rgba(99, 102, 241, 0.05);
        }

        .dropzone input {
            display: none;
        }

        .dropzone-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-subtle);
            border: 1px solid var(--border-active);
        }

        .dropzone-text {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .dropzone-sub {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--gradient-main);
            color: #fff;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.25);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 28px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--border-active);
        }

        /* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar-bg {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            border-radius: 3px;
            background: var(--gradient-main);
            transition: width 0.5s ease;
        }

        .progress-status {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .results {
            margin-top: 24px;
        }

        .result-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 16px;
        }

        .result-section h3 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-section pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 800;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* â”€â”€ Concept Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: var(--gradient-subtle);
            border: 1px solid var(--border-active);
            color: var(--accent-1);
        }

        /* â”€â”€ Question Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .question-group {
            margin-bottom: 16px;
        }

        .question-group h4 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .question-item {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            line-height: 1.5;
            border-left: 3px solid var(--accent-1);
        }

        .question-group.medium .question-item {
            border-left-color: var(--warning);
        }

        .question-group.hard .question-item {
            border-left-color: var(--error);
        }

        /* â”€â”€ Live Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stream-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .stream-layout {
                grid-template-columns: 1fr;
            }
        }

        .video-preview {
            width: 100%;
            border-radius: var(--radius-sm);
            background: #000;
            aspect-ratio: 16/9;
            object-fit: cover;
        }

        .stream-log {
            background: rgba(0, 0, 0, 0.4);
            border-radius: var(--radius-sm);
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .log-entry .time {
            color: var(--accent-1);
            margin-right: 8px;
        }

        .log-entry .label {
            color: var(--success);
        }

        /* â”€â”€ Formula block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .formula-card {
            padding: 14px 18px;
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .formula-latex {
            font-size: 16px;
            font-weight: 600;
            font-family: 'Cambria Math', serif;
            margin-bottom: 4px;
        }

        .formula-explain {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* â”€â”€ Highlight timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .highlight-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .highlight-time {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-1);
            min-width: 50px;
        }

        .highlight-text {
            font-size: 13px;
        }

        /* â”€â”€ Buttons row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .footer {
            text-align: center;
            padding: 32px;
            font-size: 12px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
        }

        .footer a {
            color: var(--accent-1);
            text-decoration: none;
        }

        /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 20px;
            font-size: 13px;
            box-shadow: var(--shadow);
            animation: toastIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(12px);
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(60px) scale(0.9);
            }

            60% {
                opacity: 1;
                transform: translateX(-6px) scale(1.02);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        /* â”€â”€ Button Microinteractions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.25);
        }

        .btn:active {
            transform: translateY(0) scale(0.97);
        }

        .btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255, 255, 255, 0.2), transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .btn:hover::after {
            opacity: 1;
        }

        /* â”€â”€ Card hover animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            border-color: rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.08);
        }

        /* â”€â”€ Progress bar shimmer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .progress-bar {
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
            animation: shimmer 1.8s ease-in-out infinite;
        }

        @keyframes shimmer {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100%);
            }
        }

        /* â”€â”€ Stream chunk success/fail micro-animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes chunkSuccess {
            0% {
                background: rgba(34, 197, 94, 0.15);
            }

            100% {
                background: transparent;
            }
        }

        @keyframes chunkFail {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-4px);
            }

            40% {
                transform: translateX(4px);
            }

            60% {
                transform: translateX(-3px);
            }

            80% {
                transform: translateX(2px);
            }
        }

        /* â”€â”€ Badge pulse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .badge {
            animation: badgePulse 3s ease-in-out infinite;
        }

        @keyframes badgePulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(99, 102, 241, 0);
            }
        }

        /* â”€â”€ Sparkle effect for completed actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sparkle-container {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-2);
            animation: sparkleAnim 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        @keyframes sparkleAnim {
            0% {
                transform: scale(0) translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: scale(1) translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        /* â”€â”€ Reduced motion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            #cosmicCanvas {
                display: none;
            }
        }

        /* â”€â”€ Demo link in header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .demo-link {
            padding: 6px 16px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--accent-1);
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition);
        }

        .demo-link:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(168, 85, 247, 0.3));
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        /* â”€â”€ Chat panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-messages {
            min-height: 320px;
            max-height: 480px;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .chat-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 280px;
            text-align: center;
        }

        .chat-msg {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            animation: chatFadeIn 0.3s ease;
        }

        @keyframes chatFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-msg.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-msg.user .chat-avatar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .chat-msg.bot .chat-avatar {
            background: linear-gradient(135deg, #22c55e, #10b981);
        }

        .chat-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.6;
        }

        .chat-msg.user .chat-bubble {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
            border-top-right-radius: 4px;
        }

        .chat-msg.bot .chat-bubble {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-top-left-radius: 4px;
        }

        .chat-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .chat-badge.fast {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .chat-badge.polish {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .chat-provenance {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .chat-provenance-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-1);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .chat-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .chat-send-btn {
            flex-shrink: 0;
        }

        .chat-typing {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }

        .chat-typing span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typingDot 1.2s ease-in-out infinite;
        }

        .chat-typing span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .chat-typing span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes typingDot {

            0%,
            60%,
            100% {
                opacity: 0.3;
                transform: translateY(0);
            }

            30% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        /* â”€â”€ Quiz panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .quiz-score-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-1);
        }

        .quiz-provider-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .quiz-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 14px;
            transition: var(--transition);
            animation: chatFadeIn 0.4s ease;
        }

        .quiz-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
        }

        .quiz-q-num {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent-1);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .quiz-q-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 14px;
            line-height: 1.5;
        }

        .quiz-option {
            display: block;
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }

        .quiz-option:hover:not(.chosen) {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
        }

        .quiz-option.correct {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }

        .quiz-option.wrong {
            background: rgba(239, 68, 68, 0.12);
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }

        .quiz-option.chosen {
            cursor: default;
        }

        .quiz-explanation {
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(99, 102, 241, 0.06);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            display: none;
        }

        .quiz-explanation.shown {
            display: block;
        }

        .quiz-sa-answer {
            margin-top: 10px;
        }

        .quiz-sa-reveal {
            padding: 6px 14px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: #8b5cf6;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: var(--transition);
        }

        .quiz-sa-reveal:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .quiz-sa-text {
            display: none;
            margin-top: 8px;
            padding: 10px 14px;
            background: rgba(34, 197, 94, 0.06);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* â”€â”€ Export buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .export-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .btn-export {
            padding: 6px 14px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: var(--accent-1);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-export:hover {
            background: rgba(99, 102, 241, 0.18);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        /* â”€â”€ Tab bar scroll (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                flex-wrap: nowrap;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                white-space: nowrap;
                flex-shrink: 0;
                font-size: 12px;
                padding: 10px 14px;
            }

            .chat-bubble {
                max-width: 90%;
            }

            .chat-input-row {
                flex-direction: column;
            }

            .chat-input {
                width: 100%;
            }

            .chat-send-btn {
                width: 100%;
            }

            .quiz-card {
                padding: 14px;
            }

            .btn-row {
                flex-direction: column;
            }

            .export-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- Cosmic Starfield Background -->
    <canvas id="cosmicCanvas"></canvas>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo" id="logoEl">
                <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Outer ring -->
                    <circle cx="18" cy="18" r="16" stroke="url(#lg)" stroke-width="2" opacity="0.4" />
                    <circle cx="18" cy="18" r="16" stroke="url(#lg)" stroke-width="2" stroke-dasharray="100.5"
                        stroke-dashoffset="100.5"
                        style="animation: drawCircle 1.2s cubic-bezier(0.4,0,0.2,1) 0.5s forwards" />
                    <!-- Eye shape -->
                    <ellipse cx="18" cy="18" rx="10" ry="7" stroke="url(#lg)" stroke-width="1.8" fill="none" />
                    <!-- Iris -->
                    <circle cx="18" cy="18" r="4.5" fill="url(#lg)" opacity="0.9" />
                    <!-- Pupil -->
                    <circle cx="18" cy="18" r="2" fill="#0a0a0f" />
                    <!-- Eyelid (for blink) -->
                    <ellipse class="logo-eye" cx="18" cy="18" rx="10" ry="7" fill="#0a0a0f" opacity="0" />
                    <!-- Shine -->
                    <circle cx="20" cy="16" r="1.2" fill="white" opacity="0.7" />
                    <defs>
                        <linearGradient id="lg" x1="0" y1="0" x2="36" y2="36">
                            <stop stop-color="#6366f1" />
                            <stop offset="0.5" stop-color="#8b5cf6" />
                            <stop offset="1" stop-color="#a855f7" />
                        </linearGradient>
                    </defs>
                    <style>
                        @keyframes drawCircle {
                            to {
                                stroke-dashoffset: 0;
                            }
                        }
                    </style>
                </svg>
                Vision Agent
            </div>
            <span class="badge">WeMakeDevs Hackathon 2026</span>
            <a href="/demo" class="demo-link" title="Open Demo Page">ğŸ® Demo</a>
            <div id="healthDot" title="Server status"
                style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:#5a5f6e;cursor:default;padding:5px 10px;border-radius:20px;border:1px solid rgba(255,255,255,0.08);transition:all 0.3s">
                <span id="healthDotCircle"
                    style="width:8px;height:8px;border-radius:50%;background:#5a5f6e;transition:background 0.5s"></span>
                <span id="healthDotLabel">Connectingâ€¦</span>
            </div>
            <div id="modelBadge" title="Active AI Model"
                style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;color:#a78bfa;cursor:default;padding:5px 12px;border-radius:20px;border:1px solid rgba(139,92,246,0.3);background:rgba(139,92,246,0.08);transition:all 0.3s;white-space:nowrap">
                ğŸ§  <span id="modelBadgeLabel">Loadingâ€¦</span>
            </div>
        </header>

        <div class="container">
            <!-- Tabs -->
            <div class="tabs" id="tabNav">
                <button class="tab active" data-tab="upload" id="tabUpload">
                    <span>ğŸ“¤</span> Upload &amp; Analyze
                </button>
                <button class="tab" data-tab="notes" id="tabNotes">
                    <span>ğŸ“</span> AI Notes
                </button>
                <button class="tab" data-tab="stream" id="tabStream">
                    <span>ğŸ“¡</span> Live Stream
                </button>
                <button class="tab" data-tab="url" id="tabUrl">
                    <span>ğŸŒ</span> Ingest URL
                </button>
                <button class="tab" data-tab="chat" id="tabChat">
                    <span>ğŸ¤–</span> Agent Chat
                </button>
                <button class="tab" data-tab="quiz" id="tabQuiz">
                    <span>ğŸ§ª</span> Quiz
                </button>
                <button class="tab" data-tab="pose" id="tabPose"
                    style="background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(16,185,129,0.1));border-color:rgba(34,197,94,0.2);position:relative">
                    <span>ğŸ‹ï¸</span> Pose Coach
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#22c55e;color:#000;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="security" id="tabSecurity"
                    style="background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(220,38,38,0.1));border-color:rgba(239,68,68,0.2);position:relative">
                    <span>ğŸ›¡ï¸</span> Security Cam
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#ef4444;color:#fff;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="character" id="tabCharacter"
                    style="background:linear-gradient(135deg,rgba(168,85,247,0.1),rgba(139,92,246,0.1));border-color:rgba(168,85,247,0.2);position:relative">
                    <span>ğŸ§™</span> Characters
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#a855f7;color:#fff;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="crowd" id="tabCrowd"
                    style="background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(234,88,12,0.1));border-color:rgba(245,158,11,0.2);position:relative">
                    <span>ğŸ‘¥</span> Crowd Monitor
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#f59e0b;color:#000;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="gaming" id="tabGaming"
                    style="background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(59,130,246,0.1));border-color:rgba(6,182,212,0.2);position:relative">
                    <span>ğŸ®</span> Gaming AI
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#06b6d4;color:#000;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="dashboard" id="tabDashboard"
                    style="background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.1));border-color:rgba(99,102,241,0.2);position:relative">
                    <span>ğŸ“Š</span> Dashboard
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#6366f1;color:#fff;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="ecowatch" id="tabEcoWatch"
                    style="background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(5,150,105,0.1));border-color:rgba(34,197,94,0.2);position:relative">
                    <span>ğŸŒ¿</span> EcoWatch
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#22c55e;color:#000;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="blindspot" id="tabBlindSpot"
                    style="background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(245,158,11,0.1));border-color:rgba(251,191,36,0.2);position:relative">
                    <span>ğŸš—</span> BlindSpot
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#fbbf24;color:#000;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="meeting" id="tabMeeting"
                    style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(37,99,235,0.1));border-color:rgba(59,130,246,0.2);position:relative">
                    <span>ğŸ“‹</span> Meeting AI
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#3b82f6;color:#fff;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
                <button class="tab" data-tab="access" id="tabAccess"
                    style="background:linear-gradient(135deg,rgba(244,63,94,0.1),rgba(219,39,119,0.1));border-color:rgba(244,63,94,0.2);position:relative">
                    <span>â™¿</span> Accessibility
                    <span
                        style="position:absolute;top:-4px;right:-4px;background:#f43f5e;color:#fff;font-size:8px;font-weight:800;padding:2px 5px;border-radius:8px">NEW</span>
                </button>
            </div>


            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 1: Upload & Analyze â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel active" id="panelUpload">
                <div class="card">
                    <div class="card-title">ğŸ¬ Upload Video</div>
                    <div class="card-desc">Upload a short video (10â€“60 s recommended). The agent will extract frames,
                        transcribe audio, and detect objects.</div>

                    <div class="dropzone" id="dropzone">
                        <input type="file" id="fileInput" accept="video/*" />
                        <div class="dropzone-icon">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                                viewBox="0 0 24 24" style="color:var(--accent-1)">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                        </div>
                        <div class="dropzone-text">Drag & drop your video here</div>
                        <div class="dropzone-sub">or click to browse â€” MP4, MOV, WebM supported</div>
                    </div>

                    <div class="progress-container" id="progressArea">
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-status">
                            <span id="progressLabel">Uploadingâ€¦</span>
                            <span id="progressPct">0%</span>
                        </div>
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-primary" id="btnUpload" disabled>
                            <span>ğŸ“¤</span> Upload Only (Frames)
                        </button>
                        <button class="btn btn-primary" id="btnAnalyze" disabled>
                            <span>ğŸ”¬</span> Full Analysis
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div class="results" id="uploadResults" style="display:none">
                    <div class="metric-grid" id="metricsGrid"></div>
                    <div class="result-section" id="transcriptSection" style="display:none">
                        <h3>ğŸ™ï¸ Transcript</h3>
                        <pre id="transcriptText"></pre>
                    </div>
                    <div class="result-section" id="detectionsSection" style="display:none">
                        <h3>ğŸ” Detections Summary</h3>
                        <pre id="detectionsText"></pre>
                    </div>
                    <div class="result-section" id="rawJsonSection">
                        <h3>ğŸ“„ Raw JSON</h3>
                        <pre id="rawJson"></pre>
                        <div class="export-btn-row" style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                            <button class="btn btn-secondary" id="btnExportAnalysis"
                                style="font-size:12px;padding:8px 14px">
                                <span>ğŸ“Š</span> Export Analysis JSON
                            </button>
                            <button class="btn btn-secondary" id="btnExportTranscript"
                                style="font-size:12px;padding:8px 14px">
                                <span>ğŸ™ï¸</span> Export Transcript JSON
                            </button>
                            <button class="btn btn-secondary" id="btnExportDetections"
                                style="font-size:12px;padding:8px 14px">
                                <span>ğŸ”</span> Export Detections JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 2: AI Notes â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelNotes">
                <div class="card">
                    <div class="card-title">ğŸ§  Generate AI Study Notes</div>
                    <div class="card-desc">Uses an LLM (OpenAI) to turn transcript + detections into structured notes,
                        formulas, and viva questions. Requires running Full Analysis first.</div>
                    <div id="notesStemHint"
                        style="display:none;margin-bottom:12px;padding:10px 14px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;font-size:13px;color:#22c55e">
                        âœ… Video stem auto-detected from your last analysis. Click "Generate Notes" to proceed.
                    </div>
                    <div id="notesNoAnalysis"
                        style="margin-bottom:12px;padding:10px 14px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;font-size:13px;color:#f59e0b">
                        âš ï¸ No analysis found yet. Go to "Upload & Analyze" tab and run Full Analysis first.
                    </div>

                    <div style="display:flex;gap:12px;align-items:center">
                        <input type="text" id="noteStem" value="video" placeholder="video stem name"
                            style="flex:1;padding:12px 16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:inherit;font-size:14px" />
                        <button class="btn btn-primary" id="btnNotes">
                            <span>âœ¨</span> Generate Notes
                        </button>
                    </div>
                </div>

                <div class="results" id="notesResults" style="display:none">
                    <!-- Summary -->
                    <div class="result-section" id="notesSummarySection">
                        <h3>ğŸ“‹ Summary</h3>
                        <p id="notesSummary" style="font-size:14px;line-height:1.7;color:var(--text-secondary)"></p>
                    </div>
                    <!-- Key Concepts -->
                    <div class="result-section" id="notesConceptsSection">
                        <h3>ğŸ’¡ Key Concepts</h3>
                        <div class="tag-list" id="notesConceptTags"></div>
                    </div>
                    <!-- Formulas -->
                    <div class="result-section" id="notesFormulasSection">
                        <h3>ğŸ“ Formulas</h3>
                        <div id="notesFormulas"></div>
                    </div>
                    <!-- Viva Questions -->
                    <div class="result-section" id="notesVivaSection">
                        <h3>â“ Viva Questions</h3>
                        <div id="notesViva"></div>
                    </div>
                    <!-- Highlights -->
                    <div class="result-section" id="notesHighlightsSection">
                        <h3>ğŸ¯ Highlights</h3>
                        <div id="notesHighlights"></div>
                    </div>
                    <!-- Raw JSON -->
                    <div class="result-section">
                        <h3>ğŸ“„ Raw Notes JSON</h3>
                        <pre id="notesRawJson"></pre>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 3: Live Stream â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelStream">
                <div class="card">
                    <div class="card-title">ğŸ“¡ Real-Time Vision Agent Stream</div>
                    <div class="card-desc">Stream from your webcam â€” each 2s chunk gets instant YOLO detection with
                        bounding boxes, transcription, and agent reasoning.</div>

                    <div class="stream-layout" style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                        <!-- Left: Video + Controls -->
                        <div>
                            <!-- Video container with canvas overlay for bboxes -->
                            <div
                                style="position:relative;border-radius:var(--radius-sm);overflow:hidden;background:#000;aspect-ratio:4/3">
                                <video id="videoPreview" style="width:100%;height:100%;object-fit:cover;display:block"
                                    autoplay playsinline muted></video>
                                <canvas id="bboxCanvas"
                                    style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></canvas>
                                <!-- Latency overlay -->
                                <div id="latencyOverlay"
                                    style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#10b981;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace;display:none">
                                    <span id="latencyMs">0</span>ms
                                </div>
                                <!-- Detection count badge -->
                                <div id="detCountBadge"
                                    style="position:absolute;top:8px;left:8px;background:rgba(99,102,241,0.85);color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;display:none">
                                    ğŸ” <span id="detCountNum">0</span> objects
                                </div>
                            </div>

                            <div class="btn-row" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn btn-primary" id="btnStartStream">
                                    <span>â–¶ï¸</span> Start Stream
                                </button>
                                <button class="btn btn-secondary" id="btnStopStream" disabled>
                                    <span>â¹ï¸</span> Stop
                                </button>
                                <button class="btn btn-secondary" id="btnFinalize" disabled>
                                    <span>ğŸ”—</span> Finalize
                                </button>
                                <button class="btn btn-secondary" id="btnToggleOverlay"
                                    style="margin-left:auto;font-size:12px" title="Toggle detection overlay">
                                    ğŸ¯ Overlay: ON
                                </button>
                            </div>
                        </div>

                        <!-- Right: Metrics + Log + Agent -->
                        <div style="display:flex;flex-direction:column;gap:12px">
                            <!-- Real-time metrics dashboard -->
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"
                                id="streamMetricsGrid">
                                <div
                                    style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:var(--radius-sm);padding:10px;text-align:center">
                                    <div style="font-size:20px;font-weight:700;color:var(--accent-1)" id="metricChunks">
                                        0</div>
                                    <div
                                        style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">
                                        Chunks</div>
                                </div>
                                <div
                                    style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:var(--radius-sm);padding:10px;text-align:center">
                                    <div style="font-size:20px;font-weight:700;color:#10b981" id="metricLatency">â€”</div>
                                    <div
                                        style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">
                                        Avg Latency</div>
                                </div>
                                <div
                                    style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:var(--radius-sm);padding:10px;text-align:center">
                                    <div style="font-size:20px;font-weight:700;color:#a855f7" id="metricObjects">0</div>
                                    <div
                                        style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">
                                        Objects</div>
                                </div>
                                <div
                                    style="background:rgba(236,72,153,0.08);border:1px solid rgba(236,72,153,0.2);border-radius:var(--radius-sm);padding:10px;text-align:center">
                                    <div style="font-size:20px;font-weight:700;color:#ec4899" id="metricFrames">0</div>
                                    <div
                                        style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">
                                        Frames</div>
                                </div>
                                <div
                                    style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:var(--radius-sm);padding:10px;text-align:center">
                                    <div style="font-size:20px;font-weight:700;color:#f59e0b" id="metricP90">â€”</div>
                                    <div
                                        style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">
                                        P90 Latency</div>
                                </div>
                                <div
                                    style="background:rgba(14,165,233,0.08);border:1px solid rgba(14,165,233,0.2);border-radius:var(--radius-sm);padding:10px;text-align:center">
                                    <div style="font-size:20px;font-weight:700;color:#0ea5e9" id="metricFPS">â€”</div>
                                    <div
                                        style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">
                                        Model FPS</div>
                                </div>
                            </div>

                            <!-- Detected labels (live) -->
                            <div id="liveLabels"
                                style="min-height:36px;display:flex;flex-wrap:wrap;gap:6px;padding:4px 0"></div>

                            <!-- Stream log -->
                            <div class="stream-log" id="streamLog"
                                style="flex:1;min-height:140px;max-height:260px;overflow-y:auto;background:rgba(0,0,0,0.3);border-radius:var(--radius-sm);padding:10px;font-size:12px;font-family:'JetBrains Mono',monospace">
                                <div style="color:var(--text-muted)">Waiting to startâ€¦</div>
                            </div>

                            <!-- Agent chat (Part 2 placeholder) -->
                            <div id="agentChatPanel"
                                style="background:rgba(99,102,241,0.04);border:1px solid rgba(99,102,241,0.15);border-radius:var(--radius-sm);padding:10px">
                                <div
                                    style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent-1);margin-bottom:6px">
                                    ğŸ¤– Agent Response</div>
                                <div id="agentResponse"
                                    style="font-size:13px;color:var(--text-secondary);min-height:20px">Click any label
                                    above to ask the agentâ€¦</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 4: Ingest URL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelUrl">
                <div class="card">
                    <div class="card-title">ğŸŒ Ingest Video from URL</div>
                    <div class="card-desc">Paste a public video URL (YouTube, Vimeo, Facebook, X/Twitter, Twitch) and
                        we'll
                        download, analyze, and generate notes automatically.</div>

                    <div style="margin-bottom:16px">
                        <input type="text" id="urlInput" placeholder="https://www.youtube.com/watch?v=..."
                            style="width:100%;padding:14px 18px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:14px;font-family:inherit;outline:none;transition:var(--transition)" />
                    </div>

                    <div
                        style="margin-bottom:16px;padding:12px 16px;background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.15);border-radius:var(--radius-sm);font-size:12px;color:var(--text-secondary)">
                        ğŸ“‹ Supported: YouTube, Vimeo, Facebook, X/Twitter, Twitch, Dailymotion, Instagram<br>
                        âš¡ If captions are available, we use those (faster &amp; free). Otherwise we download and
                        transcribe.
                    </div>

                    <label
                        style="display:flex;align-items:center;gap:10px;margin-bottom:16px;cursor:pointer;font-size:13px">
                        <input type="checkbox" id="urlConsent"
                            style="width:18px;height:18px;accent-color:var(--accent-1);cursor:pointer" />
                        <span>I confirm I have the right to analyze this video</span>
                    </label>

                    <div class="btn-row">
                        <button class="btn btn-primary" id="btnFetchAnalyze" disabled>
                            <span>ğŸš€</span> Fetch &amp; Analyze
                        </button>
                    </div>

                    <div class="progress-container" id="urlProgressArea">
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="urlProgressBar"></div>
                        </div>
                        <div class="progress-status">
                            <span id="urlProgressLabel">Downloadingâ€¦</span>
                            <span id="urlProgressPct"></span>
                        </div>
                    </div>
                </div>

                <!-- URL Results -->
                <div class="results" id="urlResults" style="display:none">
                    <div class="card">
                        <div class="card-title">âœ… Analysis Complete</div>
                        <div id="urlResultContent" style="font-size:13px;line-height:1.8"></div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 5: Agent Chat â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelChat">
                <div class="card">
                    <div class="card-title">ğŸ¤– Ask the Agent</div>
                    <div class="card-desc">Ask questions about your analyzed video. The agent uses 2-tier replies:
                        instant FastReply from YOLO labels + transcript, then a polished LLM reply in the background.
                    </div>
                    <div id="chatNoAnalysis"
                        style="margin-bottom:12px;padding:10px 14px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;font-size:13px;color:#f59e0b">
                        âš ï¸ No analysis found yet. Upload &amp; analyze a video first, then come back to chat.
                    </div>
                    <div id="chatReadyHint"
                        style="display:none;margin-bottom:12px;padding:10px 14px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;font-size:13px;color:#22c55e">
                        âœ… Video stem detected: <strong id="chatStemLabel">â€”</strong>. Ask anything about the video
                        below!
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-empty" id="chatEmpty">
                        <div style="font-size:48px;margin-bottom:12px">ğŸ’¬</div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary)">Start a conversation</div>
                        <div style="font-size:13px;color:var(--text-muted);margin-top:4px">Ask about objects detected,
                            transcript content, or any scene details</div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="Ask about your videoâ€¦" class="chat-input" />
                    <button class="btn btn-primary chat-send-btn" id="btnChatSend">
                        <span>ğŸš€</span> Send
                    </button>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 6: Quiz â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelQuiz">
                <div class="card">
                    <div class="card-title">ğŸ§ª Interactive Quiz</div>
                    <div class="card-desc">Generate MCQ and short-answer questions from your video analysis. Test your
                        understanding of the content!</div>
                    <div id="quizNoAnalysis"
                        style="margin-bottom:12px;padding:10px 14px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;font-size:13px;color:#f59e0b">
                        âš ï¸ No analysis found yet. Upload &amp; analyze a video first, then generate a quiz.
                    </div>
                    <div id="quizReadyHint"
                        style="display:none;margin-bottom:12px;padding:10px 14px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;font-size:13px;color:#22c55e">
                        âœ… Video stem detected: <strong id="quizStemLabel">â€”</strong>. Click Generate Quiz!
                    </div>
                    <div class="btn-row" style="flex-wrap: wrap; gap: 10px;">
                        <div style="display:flex;align-items:center;gap:8px">
                            <label style="font-size:13px;color:var(--text-secondary)">Questions:</label>
                            <input type="number" id="quizCount" value="5" min="1" max="20"
                                style="width:60px;padding:8px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:inherit;font-size:14px" />
                        </div>
                        <button class="btn btn-primary" id="btnQuizGen">
                            <span>ğŸ²</span> Generate Quiz
                        </button>
                    </div>
                </div>

                <!-- Quiz Results -->
                <div id="quizResults" style="display:none">
                    <div class="quiz-score-bar" id="quizScoreBar">
                        <span id="quizScoreText">Score: 0 / 0</span>
                        <span id="quizProviderBadge" class="quiz-provider-badge"></span>
                    </div>
                    <div id="quizCards"></div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 7: Pose Coach (NEW) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelPose">
                <div class="card"
                    style="border-color:rgba(34,197,94,0.2);background:linear-gradient(135deg,rgba(34,197,94,0.03),rgba(16,185,129,0.03))">
                    <div class="card-title" style="color:#22c55e">ğŸ‹ï¸ AI Pose Coach</div>
                    <div class="card-desc">Open your webcam â€” the AI watches you exercise in real-time, counts reps,
                        measures angles, and speaks posture corrections aloud.</div>

                    <!-- Exercise + TTS controls -->
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
                        <div style="display:flex;align-items:center;gap:8px">
                            <label style="font-size:13px;color:var(--text-secondary)">Exercise:</label>
                            <select id="poseExercise"
                                style="padding:8px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:inherit;font-size:13px">
                                <option value="squat">ğŸ¦µ Squat</option>
                                <option value="pushup">ğŸ’ª Push-up</option>
                                <option value="curl">ğŸ¤¸ Bicep Curl</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="btnPoseStart"
                            style="background:linear-gradient(135deg,#22c55e,#10b981);border-color:#22c55e">
                            <span>ğŸ“·</span> Start Camera
                        </button>
                        <button class="btn btn-secondary" id="btnPoseStop" disabled>â¹ï¸ Stop</button>
                        <button class="btn btn-secondary" id="btnPoseReset">ğŸ”„ Reset Reps</button>
                        <label
                            style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-secondary);cursor:pointer;margin-left:auto">
                            <input type="checkbox" id="poseTtsToggle" checked style="accent-color:#22c55e" />
                            ğŸ”Š Voice Coach
                        </label>
                    </div>

                    <!-- Main layout: video + metrics -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                        <!-- Video feed -->
                        <div>
                            <div
                                style="position:relative;border-radius:var(--radius-sm);overflow:hidden;background:#000;aspect-ratio:4/3;border:2px solid rgba(34,197,94,0.3)">
                                <video id="poseVideo" style="width:100%;height:100%;object-fit:cover;display:block"
                                    autoplay playsinline muted></video>
                                <canvas id="poseCanvas"
                                    style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></canvas>
                                <!-- Rep counter overlay -->
                                <div id="poseRepOverlay"
                                    style="position:absolute;bottom:10px;left:10px;background:rgba(34,197,94,0.9);color:#000;padding:6px 14px;border-radius:10px;font-size:22px;font-weight:900;display:none">
                                    <span id="poseRepCount">0</span> reps
                                </div>
                                <!-- State badge -->
                                <div id="poseStateBadge"
                                    style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:#22c55e;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700;display:none">
                                    <span id="poseStateText">â€”</span>
                                </div>
                            </div>
                            <div id="poseStatus"
                                style="margin-top:8px;font-size:12px;color:var(--text-muted);text-align:center">
                                ğŸ“· Camera not started
                            </div>
                        </div>

                        <!-- Right: metrics + corrections -->
                        <div style="display:flex;flex-direction:column;gap:12px">
                            <!-- Angle gauge -->
                            <div
                                style="background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.2);border-radius:var(--radius-sm);padding:16px;text-align:center">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">
                                    Joint Angle</div>
                                <div id="poseAngle" style="font-size:42px;font-weight:900;color:#22c55e;line-height:1">
                                    â€”Â°</div>
                                <!-- Angle bar -->
                                <div
                                    style="margin-top:10px;background:rgba(255,255,255,0.05);border-radius:4px;height:8px;overflow:hidden;position:relative">
                                    <div id="poseAngleBar"
                                        style="position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#10b981);border-radius:4px;transition:width .3s ease">
                                    </div>
                                    <!-- Target zone marker (90Â°) -->
                                    <div style="position:absolute;left:50%;top:0;height:100%;width:2px;background:#f59e0b;border-radius:2px"
                                        title="Target: 90Â°"></div>
                                </div>
                                <div
                                    style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:4px">
                                    <span>0Â°</span><span>90Â° target</span><span>180Â°</span>
                                </div>
                            </div>

                            <!-- Rep counter card -->
                            <div
                                style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:var(--radius-sm);padding:16px;text-align:center">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">
                                    Reps Completed</div>
                                <div id="poseRepsLarge"
                                    style="font-size:56px;font-weight:900;color:var(--accent-1);line-height:1;background:var(--gradient-main);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">
                                    0</div>
                                <div id="poseExerciseLabel"
                                    style="font-size:13px;color:var(--text-secondary);margin-top:6px">Squat</div>
                            </div>

                            <!-- Posture corrections -->
                            <div
                                style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-radius:var(--radius-sm);padding:14px;flex:1">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px">
                                    ğŸ¯ Coaching Cues</div>
                                <div id="poseCorrections"
                                    style="font-size:13px;color:var(--text-secondary);line-height:1.8">
                                    <em style="color:var(--text-muted)">Start camera to receive coaching cuesâ€¦</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• TAB 8: Security Camera â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelSecurity">
                <div class="card"
                    style="border-color:rgba(239,68,68,0.25);background:linear-gradient(135deg,rgba(239,68,68,0.04),rgba(220,38,38,0.04))">
                    <div class="card-title" style="color:#ef4444">ğŸ›¡ï¸ AI Security Camera</div>
                    <div class="card-desc">Real-time threat detection. The AI watches your webcam and alerts on
                        suspicious activity, weapons, and crowd surges.</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                        <button class="btn btn-primary" id="btnSecStart"
                            style="background:linear-gradient(135deg,#ef4444,#dc2626);border-color:#ef4444">ğŸ“· Start
                            Camera</button>
                        <button class="btn btn-secondary" id="btnSecStop" disabled>â¹ï¸ Stop</button>
                        <button class="btn btn-secondary" id="btnSecPoster">ğŸ–¼ï¸ Wanted Poster</button>
                        <div id="secAlertBadge"
                            style="padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;border:1px solid rgba(255,255,255,0.1);color:#5a5f6e;background:rgba(255,255,255,0.04)">
                            âœ… ALL CLEAR</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div style="position:relative">
                            <video id="secVideo" autoplay muted playsinline
                                style="width:100%;border-radius:10px;background:#000;max-height:260px;object-fit:cover"></video>
                            <canvas id="secCanvas"
                                style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:10px;pointer-events:none"></canvas>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <div
                                style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px;flex:1">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">
                                    ğŸ” Detections</div>
                                <div id="secDetections"
                                    style="font-size:13px;color:var(--text-secondary);line-height:1.7"><em
                                        style="color:var(--text-muted)">Waiting for cameraâ€¦</em></div>
                            </div>
                            <div
                                style="background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:10px;padding:14px;max-height:130px;overflow-y:auto">
                                <div
                                    style="font-size:11px;font-weight:600;color:#ef4444;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">
                                    ğŸš¨ Alert Log</div>
                                <div id="secAlertLog"
                                    style="font-size:12px;color:var(--text-secondary);line-height:1.6"><em
                                        style="color:var(--text-muted)">No alerts yet</em></div>
                            </div>
                        </div>
                    </div>
                    <!-- Wanted Poster Modal -->
                    <div id="secPosterModal"
                        style="display:none;margin-top:14px;padding:16px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:12px">
                        <div style="font-size:13px;font-weight:700;color:#ef4444;margin-bottom:8px">ğŸ“œ WANTED POSTER
                        </div>
                        <pre id="secPosterText"
                            style="font-size:12px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.6"></pre>
                    </div>
                </div>
            </div>

            <!-- â•â•â• TAB 9: Character Chat â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelCharacter">
                <div class="card"
                    style="border-color:rgba(168,85,247,0.25);background:linear-gradient(135deg,rgba(168,85,247,0.04),rgba(139,92,246,0.04))">
                    <div class="card-title" style="color:#a855f7">ğŸ§™ AI Character Personas</div>
                    <div class="card-desc">Chat with unique AI characters â€” each with distinct personality, expertise,
                        and voice. Enable your mic or type to talk.</div>
                    <!-- Persona selector -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px" id="personaGrid"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
                        <!-- Avatar + Video -->
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <div id="charAvatar"
                                style="height:130px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:64px;background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);transition:all 0.4s">
                                ğŸ§™</div>
                            <div style="font-size:13px;font-weight:600;text-align:center;color:#a855f7" id="charName">
                                Select a persona</div>
                            <div style="font-size:11px;text-align:center;color:var(--text-muted)" id="charTitle">Pick a
                                character to begin</div>
                            <video id="charVideo" autoplay muted playsinline
                                style="width:100%;border-radius:10px;background:#000;height:140px;object-fit:cover;display:none"></video>
                        </div>
                        <!-- Chat window -->
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <div id="charMessages"
                                style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px;height:250px;overflow-y:auto;display:flex;flex-direction:column;gap:8px">
                                <em style="color:var(--text-muted);font-size:13px;text-align:center;margin:auto">Select
                                    a character and type a messageâ€¦</em>
                            </div>
                        </div>
                    </div>
                    <!-- Input row -->
                    <div style="display:flex;gap:8px;align-items:center">
                        <button id="btnCharMic" title="Hold to speak"
                            style="width:40px;height:40px;border-radius:50%;background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);color:#a855f7;font-size:18px;cursor:pointer;flex-shrink:0;transition:all 0.2s">ğŸ¤</button>
                        <input id="charInput" type="text" placeholder="Talk to the characterâ€¦"
                            style="flex:1;padding:10px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:inherit;font-size:14px" />
                        <button class="btn btn-primary" id="btnCharSend"
                            style="background:linear-gradient(135deg,#a855f7,#8b5cf6)">ğŸš€ Send</button>
                        <button class="btn btn-secondary" id="btnCharReset">ğŸ”„</button>
                        <label
                            style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text-muted);cursor:pointer;white-space:nowrap">
                            <input type="checkbox" id="charTtsToggle" checked style="accent-color:#a855f7" /> Voice
                        </label>
                    </div>
                </div>
            </div>

            <!-- â•â•â• TAB 10: Crowd Monitor â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelCrowd">
                <div class="card"
                    style="border-color:rgba(245,158,11,0.25);background:linear-gradient(135deg,rgba(245,158,11,0.04),rgba(234,88,12,0.04))">
                    <div class="card-title" style="color:#f59e0b">ğŸ‘¥ AI Crowd Safety Monitor</div>
                    <div class="card-desc">Real-time crowd density estimation, distress detection, and safety scoring.
                        The heatmap shows where people are concentrated.</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                        <button class="btn btn-primary" id="btnCrowdStart"
                            style="background:linear-gradient(135deg,#f59e0b,#d97706);border-color:#f59e0b">ğŸ“· Start
                            Camera</button>
                        <button class="btn btn-secondary" id="btnCrowdStop" disabled>â¹ï¸ Stop</button>
                        <div id="crowdSafetyBadge"
                            style="padding:6px 16px;border-radius:20px;font-size:12px;font-weight:700;border:1px solid rgba(34,197,94,0.4);color:#22c55e;background:rgba(34,197,94,0.08)">
                            âœ… SAFE</div>
                        <div style="margin-left:auto;font-size:13px;color:var(--text-secondary)">Count: <strong
                                id="crowdCount" style="color:#f59e0b">0</strong></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div style="position:relative">
                            <video id="crowdVideo" autoplay muted playsinline
                                style="width:100%;border-radius:10px;background:#000;max-height:240px;object-fit:cover"></video>
                            <canvas id="crowdCanvas"
                                style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:10px;opacity:0.7;pointer-events:none"></canvas>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <!-- Safety gauge -->
                            <div
                                style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                    Safety Score</div>
                                <div style="font-size:42px;font-weight:800;text-align:center" id="crowdScoreNum"
                                    style="color:#22c55e">â€”</div>
                                <div
                                    style="height:8px;background:rgba(255,255,255,0.08);border-radius:8px;overflow:hidden;margin-top:8px">
                                    <div id="crowdScoreBar"
                                        style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#10b981);transition:width 0.5s,background 0.5s;border-radius:8px">
                                    </div>
                                </div>
                            </div>
                            <!-- Heatmap -->
                            <div
                                style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                    ğŸŒ¡ï¸ Crowd Heatmap</div>
                                <canvas id="crowdHeatmap" width="200" height="120"
                                    style="width:100%;border-radius:6px;image-rendering:pixelated"></canvas>
                            </div>
                            <!-- Status log -->
                            <div
                                style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.15);border-radius:10px;padding:10px;max-height:100px;overflow-y:auto">
                                <div id="crowdLog" style="font-size:12px;color:var(--text-secondary);line-height:1.6">
                                    <em style="color:var(--text-muted)">Monitoringâ€¦</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• TAB 11: Gaming Companion â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelGaming">
                <div class="card"
                    style="border-color:rgba(6,182,212,0.25);background:linear-gradient(135deg,rgba(6,182,212,0.04),rgba(59,130,246,0.04))">
                    <div class="card-title" style="color:#06b6d4">ğŸ® AI Gaming Companion</div>
                    <div class="card-desc">Upload a game screenshot or share your screen. The AI coach analyzes your
                        position, strategy, and gives real-time advice with voice commentary.</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div>
                            <!-- Game type + upload -->
                            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
                                <select id="gameType"
                                    style="padding:8px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:inherit;font-size:13px">
                                    <option value="general">ğŸ® General</option>
                                    <option value="chess">â™Ÿï¸ Chess</option>
                                    <option value="fps">ğŸ”« FPS</option>
                                    <option value="moba">âš”ï¸ MOBA</option>
                                    <option value="rts">ğŸ° RTS</option>
                                    <option value="puzzle">ğŸ§© Puzzle</option>
                                    <option value="racing">ğŸï¸ Racing</option>
                                    <option value="sports">âš½ Sports</option>
                                </select>
                                <button class="btn btn-primary" id="btnGamingUpload"
                                    style="background:linear-gradient(135deg,#06b6d4,#3b82f6)">ğŸ“¤ Upload
                                    Screenshot</button>
                                <input type="file" id="gamingFileInput" accept="image/*" style="display:none" />
                                <button class="btn btn-secondary" id="btnGamingAnalyze" disabled>ğŸ”¬ Analyze</button>
                                <label
                                    style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text-muted);cursor:pointer">
                                    <input type="checkbox" id="gamingTts" checked style="accent-color:#06b6d4" /> Voice
                                </label>
                            </div>
                            <!-- Preview -->
                            <div
                                style="position:relative;border-radius:10px;overflow:hidden;background:#000;min-height:200px;display:flex;align-items:center;justify-content:center">
                                <img id="gamingPreview"
                                    style="max-width:100%;max-height:260px;display:none;border-radius:10px" />
                                <span id="gamingPreviewPlaceholder" style="font-size:48px;opacity:0.3">ğŸ®</span>
                            </div>
                            <!-- Context input -->
                            <input id="gamingContext" type="text"
                                placeholder="Additional context (e.g. 'I'm running low on ammo')â€¦"
                                style="margin-top:10px;width:100%;padding:10px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-family:inherit;font-size:13px" />
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <!-- Advice output -->
                            <div
                                style="background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.2);border-radius:10px;padding:14px;flex:1">
                                <div
                                    style="font-size:11px;font-weight:600;color:#06b6d4;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px">
                                    ğŸ§  AI Strategy Advice</div>
                                <div id="gamingAdvice"
                                    style="font-size:14px;color:var(--text-secondary);line-height:1.7"><em
                                        style="color:var(--text-muted)">Upload a screenshot to get AI coachingâ€¦</em>
                                </div>
                                <div id="gamingLatency" style="font-size:11px;color:var(--text-muted);margin-top:8px">
                                </div>
                            </div>
                            <!-- Advice history -->
                            <div
                                style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px;max-height:180px;overflow-y:auto">
                                <div
                                    style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                    ğŸ“œ Advice History</div>
                                <div id="gamingHistory"
                                    style="font-size:12px;color:var(--text-secondary);line-height:1.7"><em
                                        style="color:var(--text-muted)">No advice yet</em></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• TAB 12: Performance Dashboard â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="tab-panel" id="panelDashboard">
                <div class="card"
                    style="border-color:rgba(99,102,241,0.25);background:linear-gradient(135deg,rgba(99,102,241,0.04),rgba(139,92,246,0.04))">
                    <div class="card-title" style="color:#6366f1">ğŸ“Š Performance Dashboard</div>
                    <div class="card-desc">Real-time metrics: LLM cascade status, API latency, frames processed, and
                        session statistics.</div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px"
                        id="dashMetricGrid"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <!-- Latency chart -->
                        <div
                            style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                            <div
                                style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px">
                                âš¡ API Latency (ms)</div>
                            <canvas id="latencyChart" height="100" style="width:100%"></canvas>
                        </div>
                        <!-- Cascade status -->
                        <div
                            style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                            <div
                                style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px">
                                ğŸ§  LLM Cascade</div>
                            <div id="dashCascade" style="display:flex;flex-direction:column;gap:6px"><em
                                    style="color:var(--text-muted);font-size:13px">Loadingâ€¦</em></div>
                        </div>
                        <!-- Frame sampler stats -->
                        <div
                            style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                            <div
                                style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px">
                                ğŸï¸ Frame Sampler</div>
                            <div id="dashSampler" style="font-size:13px;color:var(--text-secondary);line-height:1.8"><em
                                    style="color:var(--text-muted)">Loadingâ€¦</em></div>
                        </div>
                        <!-- Session stats -->
                        <div
                            style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                            <div
                                style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px">
                                ğŸ“ˆ Session Stats</div>
                            <div id="dashSession" style="font-size:13px;color:var(--text-secondary);line-height:1.8"><em
                                    style="color:var(--text-muted)">Loadingâ€¦</em></div>
                        </div>
                    </div>
                    <div style="margin-top:12px;text-align:center">
                        <button class="btn btn-secondary" id="btnDashRefresh">ğŸ”„ Refresh Now</button>
                    </div>
                </div>

                <!-- â•â•â• TAB 13: EcoWatch Ranger â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="tab-panel" id="panelEcoWatch">
                    <div class="card"
                        style="border-color:rgba(34,197,94,0.25);background:linear-gradient(135deg,rgba(34,197,94,0.04),rgba(5,150,105,0.04))">
                        <div class="card-title" style="color:#22c55e">ğŸŒ¿ EcoWatch Ranger</div>
                        <div class="card-desc">AI forest & wildlife surveillance. Point a camera at any forest area to
                            detect fire, unauthorized vehicles, poachers, and track wildlife sightings in real-time.
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div>
                                <div
                                    style="position:relative;border-radius:var(--radius-sm);overflow:hidden;background:#000;aspect-ratio:4/3;border:2px solid rgba(34,197,94,0.3)">
                                    <video id="ecoVideo" style="width:100%;height:100%;object-fit:cover;display:block"
                                        autoplay playsinline muted></video>
                                    <div id="ecoThreatBadge"
                                        style="position:absolute;top:10px;left:10px;padding:6px 14px;border-radius:8px;font-size:13px;font-weight:700;display:none;background:rgba(34,197,94,0.9);color:#000">
                                    </div>
                                </div>
                                <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                                    <button class="btn btn-primary" id="btnEcoStart"
                                        style="background:linear-gradient(135deg,#22c55e,#16a34a)">â–¶ Start
                                        Ranger</button>
                                    <button class="btn btn-secondary" id="btnEcoStop" disabled>â¹ Stop</button>
                                    <button class="btn btn-secondary" id="btnEcoReset">ğŸ”„ Reset</button>
                                    <input id="ecoLocation" type="text" placeholder="Location tag (e.g. Sector-A)"
                                        style="padding:7px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;width:160px">
                                </div>
                                <div id="ecoStatus" style="margin-top:8px;font-size:12px;color:var(--text-muted)">ğŸ“·
                                    Camera not started</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:12px">
                                <!-- Threat panel -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(34,197,94,0.2);border-radius:10px;padding:14px">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸš¨ Current Threat</div>
                                    <div id="ecoThreatInfo" style="font-size:22px;font-weight:800;color:#22c55e">âœ… AREA
                                        CLEAR</div>
                                    <div id="ecoThreatAction"
                                        style="font-size:12px;color:var(--text-muted);margin-top:4px">Normal monitoring
                                    </div>
                                    <div style="margin-top:8px;display:flex;gap:10px;font-size:12px">
                                        <span>ğŸ” Threats: <b id="ecoTotalThreats">0</b></span>
                                        <span>ğŸ¦ Wildlife: <b id="ecoWildlife">0</b></span>
                                        <span>âš¡ <b id="ecoLatency">â€”</b>ms</span>
                                    </div>
                                </div>
                                <!-- Detected objects -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px;flex:1">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ“‹ Alert Log</div>
                                    <div id="ecoAlertLog"
                                        style="font-size:12px;color:var(--text-secondary);line-height:2;max-height:180px;overflow-y:auto">
                                        <em style="color:var(--text-muted)">No alerts yet. Start the rangerâ€¦</em>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â• TAB 14: BlindSpot Guardian â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="tab-panel" id="panelBlindSpot">
                    <div class="card"
                        style="border-color:rgba(251,191,36,0.25);background:linear-gradient(135deg,rgba(251,191,36,0.04),rgba(245,158,11,0.04))">
                        <div class="card-title" style="color:#fbbf24">ğŸš— BlindSpot Guardian</div>
                        <div class="card-desc">AI dashcam co-pilot. Point your camera at the road to detect pedestrians,
                            cyclists, vehicles, and road hazards in real-time with voice alerts.</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div>
                                <div
                                    style="position:relative;border-radius:var(--radius-sm);overflow:hidden;background:#000;aspect-ratio:4/3;border:2px solid rgba(251,191,36,0.3)">
                                    <video id="blindVideo" style="width:100%;height:100%;object-fit:cover;display:block"
                                        autoplay playsinline muted></video>
                                    <div id="blindAlertBadge"
                                        style="position:absolute;top:10px;left:10px;padding:8px 16px;border-radius:8px;font-size:15px;font-weight:800;display:none">
                                    </div>
                                </div>
                                <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
                                    <button class="btn btn-primary" id="btnBlindStart"
                                        style="background:linear-gradient(135deg,#fbbf24,#f59e0b)">â–¶ Start
                                        Guardian</button>
                                    <button class="btn btn-secondary" id="btnBlindStop" disabled>â¹ Stop</button>
                                    <button class="btn btn-secondary" id="btnBlindReset">ğŸ”„ New Trip</button>
                                    <label
                                        style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text-muted);cursor:pointer">
                                        <input type="checkbox" id="blindVoice" checked style="accent-color:#fbbf24">
                                        Voice Alerts
                                    </label>
                                </div>
                                <div id="blindStatus" style="margin-top:8px;font-size:12px;color:var(--text-muted)">ğŸ“·
                                    Camera not started</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:12px">
                                <!-- Hazard display -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(251,191,36,0.2);border-radius:10px;padding:14px">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        âš ï¸ Road Status</div>
                                    <div id="blindTopAlert" style="font-size:18px;font-weight:800;color:#22c55e">âœ… ROAD
                                        CLEAR</div>
                                    <div id="blindTip" style="font-size:12px;color:var(--text-muted);margin-top:6px">
                                        Maintain safe following distance.</div>
                                    <div style="margin-top:8px;display:flex;gap:10px;font-size:12px">
                                        <span>âš ï¸ Hazards: <b id="blindTotal">0</b></span>
                                        <span>ğŸ• Trip: <b id="blindTrip">0s</b></span>
                                        <span>âš¡ <b id="blindLatency">â€”</b>ms</span>
                                    </div>
                                </div>
                                <!-- Hazard log -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px;flex:1">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ“‹ Hazard Log</div>
                                    <div id="blindHazardLog"
                                        style="font-size:12px;color:var(--text-secondary);line-height:2;max-height:180px;overflow-y:auto">
                                        <em style="color:var(--text-muted)">No hazards logged. Start the guardianâ€¦</em>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â• TAB 15: Meeting Assistant â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="tab-panel" id="panelMeeting">
                    <div class="card"
                        style="border-color:rgba(59,130,246,0.25);background:linear-gradient(135deg,rgba(59,130,246,0.04),rgba(37,99,235,0.04))">
                        <div class="card-title" style="color:#3b82f6">ğŸ“‹ AI Meeting Assistant</div>
                        <div class="card-desc">Real-time meeting co-pilot: participant tracking, live transcript,
                            auto-detect action items & decisions, and LLM-powered meeting summaries.</div>
                        <div style="display:grid;grid-template-columns:1fr 1.4fr;gap:16px">
                            <div>
                                <!-- Video + controls -->
                                <div
                                    style="position:relative;border-radius:var(--radius-sm);overflow:hidden;background:#000;aspect-ratio:4/3;border:2px solid rgba(59,130,246,0.3)">
                                    <video id="meetingVideo"
                                        style="width:100%;height:100%;object-fit:cover;display:block" autoplay
                                        playsinline muted></video>
                                    <div
                                        style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:700">
                                        ğŸ‘¥ <span id="meetingParticipants">0</span> participants
                                    </div>
                                </div>
                                <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                                    <button class="btn btn-primary" id="btnMeetingStart"
                                        style="background:linear-gradient(135deg,#3b82f6,#2563eb)">â–¶ Start
                                        Meeting</button>
                                    <button class="btn btn-secondary" id="btnMeetingStop" disabled>â¹ End</button>
                                    <button class="btn btn-secondary" id="btnMeetingSummarize" disabled>ğŸ§ 
                                        Summarize</button>
                                    <button class="btn btn-secondary" id="btnMeetingClear">ğŸ—‘ï¸ Clear</button>
                                </div>
                                <!-- Manual transcript input -->
                                <div style="margin-top:12px">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">
                                        â• Add Transcript</div>
                                    <div style="display:flex;gap:6px">
                                        <input id="meetingSpeaker" type="text" placeholder="Speaker"
                                            style="width:90px;padding:7px 10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px">
                                        <input id="meetingText" type="text" placeholder="What was saidâ€¦"
                                            style="flex:1;padding:7px 10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px">
                                        <button class="btn btn-primary" id="btnMeetingAdd"
                                            style="padding:7px 12px;font-size:12px">Add</button>
                                    </div>
                                </div>
                                <!-- Stats -->
                                <div
                                    style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;font-size:12px">
                                    <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px">
                                        <div style="font-size:18px;font-weight:800;color:#3b82f6" id="meetingActions">0
                                        </div>
                                        <div style="color:var(--text-muted)">Actions</div>
                                    </div>
                                    <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px">
                                        <div style="font-size:18px;font-weight:800;color:#22c55e" id="meetingDecisions">
                                            0</div>
                                        <div style="color:var(--text-muted)">Decisions</div>
                                    </div>
                                    <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:8px">
                                        <div style="font-size:18px;font-weight:800;color:#f59e0b" id="meetingDuration">
                                            0m</div>
                                        <div style="color:var(--text-muted)">Duration</div>
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:12px">
                                <!-- Live transcript -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px;flex:1">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ“ Live Transcript</div>
                                    <div id="meetingTranscript"
                                        style="font-size:12px;color:var(--text-secondary);line-height:1.9;max-height:220px;overflow-y:auto">
                                        <em style="color:var(--text-muted)">Transcript will appear hereâ€¦</em>
                                    </div>
                                </div>
                                <!-- Summary -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(59,130,246,0.2);border-radius:10px;padding:14px">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ§  AI Summary</div>
                                    <div id="meetingSummary"
                                        style="font-size:13px;color:var(--text-secondary);line-height:1.7;max-height:150px;overflow-y:auto;white-space:pre-wrap">
                                        <em style="color:var(--text-muted)">Click "Summarize" to generate a meeting
                                            summaryâ€¦</em>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â• TAB 16: Accessibility Agent â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="tab-panel" id="panelAccess">
                    <div class="card"
                        style="border-color:rgba(244,63,94,0.25);background:linear-gradient(135deg,rgba(244,63,94,0.04),rgba(219,39,119,0.04))">
                        <div class="card-title" style="color:#f43f5e">â™¿ Accessibility Agent</div>
                        <div class="card-desc">Real-time visual assistance for the visually impaired. Get live scene
                            descriptions, read text in view, navigate safely, and identify objects using AI vision.
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div>
                                <div
                                    style="position:relative;border-radius:var(--radius-sm);overflow:hidden;background:#000;aspect-ratio:4/3;border:2px solid rgba(244,63,94,0.3)">
                                    <video id="accessVideo"
                                        style="width:100%;height:100%;object-fit:cover;display:block" autoplay
                                        playsinline muted></video>
                                    <div id="accessModeBadge"
                                        style="position:absolute;top:8px;right:8px;background:rgba(244,63,94,0.9);color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700">
                                        SCENE</div>
                                </div>
                                <!-- Mode buttons -->
                                <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">
                                    <button class="btn btn-primary" id="btnAccessStart"
                                        style="background:linear-gradient(135deg,#f43f5e,#db2777)">â–¶ Start</button>
                                    <button class="btn btn-secondary" id="btnAccessStop" disabled>â¹ Stop</button>
                                </div>
                                <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
                                    <button class="btn btn-secondary access-mode-btn" data-mode="scene"
                                        style="font-size:11px;padding:5px 10px">ğŸŒ Scene</button>
                                    <button class="btn btn-secondary access-mode-btn" data-mode="navigate"
                                        style="font-size:11px;padding:5px 10px">ğŸ§­ Navigate</button>
                                    <button class="btn btn-secondary access-mode-btn" data-mode="read"
                                        style="font-size:11px;padding:5px 10px">ğŸ“– Read Text</button>
                                    <button class="btn btn-secondary access-mode-btn" data-mode="identify"
                                        style="font-size:11px;padding:5px 10px">ğŸ” Identify</button>
                                    <button class="btn btn-secondary access-mode-btn" data-mode="currency"
                                        style="font-size:11px;padding:5px 10px">ğŸ’° Currency</button>
                                </div>
                                <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                                    <label
                                        style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text-muted);cursor:pointer">
                                        <input type="checkbox" id="accessTts" checked style="accent-color:#f43f5e"> Read
                                        Aloud
                                    </label>
                                    <button class="btn btn-primary" id="btnAccessDescribe" disabled
                                        style="font-size:11px;padding:5px 12px;background:linear-gradient(135deg,#f43f5e,#db2777)">ğŸ“¸
                                        Describe Now</button>
                                </div>
                                <div id="accessStatus" style="margin-top:8px;font-size:12px;color:var(--text-muted)">ğŸ“·
                                    Camera not started</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:12px">
                                <!-- Live caption box -->
                                <div
                                    style="background:rgba(244,63,94,0.08);border:2px solid rgba(244,63,94,0.3);border-radius:12px;padding:16px">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ”Š Live Caption</div>
                                    <div id="accessCaption"
                                        style="font-size:16px;color:var(--text-primary);line-height:1.6;min-height:80px;font-weight:500">
                                        <em style="color:var(--text-muted)">Start the camera and select a modeâ€¦</em>
                                    </div>
                                    <div style="margin-top:8px;font-size:11px;color:var(--text-muted)">Provider: <span
                                            id="accessProvider">â€”</span> Â· <span id="accessLatency">â€”</span>ms</div>
                                </div>
                                <!-- Objects detected -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ“ Spatial Context</div>
                                    <div id="accessObjects"
                                        style="font-size:12px;color:var(--text-secondary);line-height:1.9">
                                        <em style="color:var(--text-muted)">Nearby objects will appear hereâ€¦</em>
                                    </div>
                                </div>
                                <!-- Caption history -->
                                <div
                                    style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px;flex:1">
                                    <div
                                        style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px">
                                        ğŸ“‹ Caption History</div>
                                    <div id="accessHistory"
                                        style="font-size:12px;color:var(--text-secondary);line-height:1.9;max-height:150px;overflow-y:auto">
                                        <em style="color:var(--text-muted)">History will appear hereâ€¦</em>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


            <footer class="footer">
                Built with â¤ï¸ for the <a href="https://wemakedevs.org" target="_blank">WeMakeDevs</a> Vision Possible
                Hackathon â€”
                Powered by <a href="https://getstream.io/video/vision-agents/" target="_blank">Vision Agents by
                    Stream</a>
                | <a href="/demo" target="_blank">ğŸ® Interactive Demo</a>
            </footer>
        </div>

        <!-- Toast container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function $(sel) { return document.querySelector(sel); }
            function $$(sel) { return document.querySelectorAll(sel); }

            function toast(msg, type = 'success') {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = `<span>${type === 'success' ? 'âœ…' : 'âŒ'}</span> ${msg}`;
                $('#toastContainer').appendChild(t);
                setTimeout(() => t.remove(), 4000);
            }

            // â”€â”€ Tab switching with animated transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function capitalise(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
            $$('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const oldPanel = $('.tab-panel.active');
                    const newId = `#panel${capitalise(tab.dataset.tab)}`;
                    const newPanel = $(newId);
                    if (oldPanel === newPanel) return;

                    $$('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Animate out old panel
                    if (oldPanel) {
                        oldPanel.animate(
                            [{ opacity: 1, transform: 'translateY(0)' }, { opacity: 0, transform: 'translateY(6px)' }],
                            { duration: 150, easing: 'cubic-bezier(.2,.9,.2,1)' }
                        ).onfinish = () => {
                            oldPanel.classList.remove('active');
                            // Animate in new panel
                            newPanel.classList.add('active');
                            newPanel.animate(
                                [{ opacity: 0, transform: 'translateY(8px)' }, { opacity: 1, transform: 'translateY(0)' }],
                                { duration: 250, easing: 'cubic-bezier(.22,1,.36,1)' }
                            );
                        };
                    } else {
                        newPanel.classList.add('active');
                    }
                });
            });

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MODEL BADGE â€” fetch /models and show active provider
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (async function loadModelBadge() {
                const badge = $('#modelBadgeLabel');
                if (!badge) return;
                try {
                    const r = await fetch('/models');
                    if (!r.ok) return;
                    const d = await r.json();
                    badge.textContent = d.active_display || d.active || 'Unknown';
                    $('#modelBadge').title = 'LLM Cascade: ' + (d.cascade_chain || '');
                } catch (e) {
                    badge.textContent = 'Gemini Flash';
                }
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // POSE COACH (Tab 7) â€” webcam frame analysis + rep counter + TTS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initPoseCoach() {
                const video = $('#poseVideo');
                const canvas = $('#poseCanvas');
                const startBtn = $('#btnPoseStart');
                const stopBtn = $('#btnPoseStop');
                const resetBtn = $('#btnPoseReset');
                const exSel = $('#poseExercise');
                const ttsChk = $('#poseTtsToggle');
                const statusEl = $('#poseStatus');
                const angleEl = $('#poseAngle');
                const angleBar = $('#poseAngleBar');
                const repsLarge = $('#poseRepsLarge');
                const repOverlay = $('#poseRepOverlay');
                const repCount = $('#poseRepCount');
                const stateBadge = $('#poseStateBadge');
                const stateText = $('#poseStateText');
                const correctionsEl = $('#poseCorrections');
                const exLabel = $('#poseExerciseLabel');

                if (!video || !startBtn) return;

                let stream = null;
                let intervalId = null;
                let lastSpokenCorrection = '';
                let lastSpeakTime = 0;
                let prevReps = 0;

                // â”€â”€ Web Speech API TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function speak(text) {
                    if (!ttsChk || !ttsChk.checked) return;
                    if (!window.speechSynthesis) return;
                    const now = Date.now();
                    // Rate-limit: don't repeat same correction within 5s
                    if (text === lastSpokenCorrection && now - lastSpeakTime < 5000) return;
                    lastSpokenCorrection = text;
                    lastSpeakTime = now;
                    const utt = new SpeechSynthesisUtterance(text.replace(/[âš ï¸ğŸ’¡ğŸ‹ï¸ğŸ“·]/g, '').trim());
                    utt.lang = 'en-US';
                    utt.rate = 1.05;
                    utt.pitch = 1.0;
                    speechSynthesis.cancel();
                    speechSynthesis.speak(utt);
                }

                // â”€â”€ Capture frame as base64 JPEG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function captureFrame() {
                    const offscreen = document.createElement('canvas');
                    offscreen.width = video.videoWidth || 320;
                    offscreen.height = video.videoHeight || 240;
                    const ctx2 = offscreen.getContext('2d');
                    ctx2.drawImage(video, 0, 0, offscreen.width, offscreen.height);
                    // Return base64 without data: prefix
                    return offscreen.toDataURL('image/jpeg', 0.7).split(',')[1] || '';
                }

                // â”€â”€ Send frame to /pose_analyze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                async function analyzeFrame() {
                    if (!stream) return;
                    const frame_b64 = captureFrame();
                    if (!frame_b64) return;

                    try {
                        const resp = await fetch('/pose_analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                exercise: exSel ? exSel.value : 'squat',
                                track_id: 0,
                                frame_b64,
                            }),
                        });
                        if (!resp.ok) return;
                        const d = await resp.json();

                        // Update angle
                        const ang = d.angle;
                        if (ang !== null && ang !== undefined) {
                            angleEl.textContent = Math.round(ang) + 'Â°';
                            const pct = Math.min(100, (ang / 180) * 100);
                            angleBar.style.width = pct + '%';
                            // Color: green=good, yellow=caution
                            const hue = ang > 80 && ang < 120 ? '142' : '45';
                            angleBar.style.background = `linear-gradient(90deg,hsl(${hue},70%,50%),hsl(${hue},50%,40%))`;
                        } else {
                            angleEl.textContent = 'â€”Â°';
                            angleBar.style.width = '0%';
                        }

                        // Update rep count
                        const reps = d.reps || 0;
                        repsLarge.textContent = reps;
                        repCount.textContent = reps;
                        repOverlay.style.display = 'flex';
                        stateBadge.style.display = 'flex';
                        stateText.textContent = (d.state || '').toUpperCase();

                        // Rep milestone announcements
                        if (reps > prevReps) {
                            speak(`${reps} reps!`);
                            // Pulse animation on reps
                            repsLarge.animate(
                                [{ transform: 'scale(1)' }, { transform: 'scale(1.25)' }, { transform: 'scale(1)' }],
                                { duration: 300, easing: 'ease' }
                            );
                            prevReps = reps;
                        }

                        // Posture corrections
                        const corrections = d.corrections || [];
                        if (corrections.length > 0) {
                            correctionsEl.innerHTML = corrections
                                .map(c => `<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">${c}</div>`)
                                .join('');
                            // Speak first correction
                            speak(corrections[0]);
                        } else {
                            const ex = exSel ? exSel.value : 'squat';
                            const stateStr = d.state === 'down' ? 'â†“ Going downâ€¦' : d.state === 'up' ? 'â†‘ Coming upâ€¦' : 'â€¦';
                            correctionsEl.innerHTML = `<div style="color:#22c55e">âœ… Good form! ${stateStr}</div>`;
                        }

                        if (!d.pose_available) {
                            statusEl.textContent = 'âš ï¸ No pose detected â€” step back so full body is visible';
                        } else {
                            statusEl.textContent = `âœ… Pose detected | Exercise: ${exSel.value} | State: ${d.state}`;
                        }

                    } catch (e) {
                        statusEl.textContent = 'âš ï¸ Pose analysis error: ' + e.message;
                    }
                }

                // â”€â”€ Start camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                startBtn.addEventListener('click', async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                            audio: false,
                        });
                        video.srcObject = stream;
                        await video.play();
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        statusEl.textContent = 'âœ… Camera active â€” stand back for full body detection';
                        exLabel.textContent = exSel ? exSel.options[exSel.selectedIndex].text : 'Squat';
                        prevReps = 0;

                        // Speak greeting
                        const ex = exSel ? exSel.value : 'squat';
                        setTimeout(() => speak(`AI Pose Coach active. Tracking your ${ex}s. Stand back so I can see your full body.`), 800);

                        // Start analyzing every 600ms
                        intervalId = setInterval(analyzeFrame, 600);

                        toast('ğŸ“· Pose Coach started!', 'success');
                    } catch (err) {
                        statusEl.textContent = 'âŒ Camera error: ' + err.message;
                        toast('Camera error: ' + err.message, 'error');
                    }
                });

                // â”€â”€ Stop camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                stopBtn.addEventListener('click', () => {
                    if (intervalId) { clearInterval(intervalId); intervalId = null; }
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    video.srcObject = null;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    repOverlay.style.display = 'none';
                    stateBadge.style.display = 'none';
                    statusEl.textContent = 'ğŸ“· Camera stopped';
                    speak('Session ended. Great workout!');
                    toast('Pose Coach stopped', 'success');
                });

                // â”€â”€ Reset reps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                resetBtn.addEventListener('click', async () => {
                    try {
                        await fetch('/pose_reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{"track_id":0}' });
                    } catch (e) { }
                    repsLarge.textContent = '0';
                    repCount.textContent = '0';
                    prevReps = 0;
                    speak('Reps reset. Starting new set!');
                    toast('Reps reset âœ…', 'success');
                });

                // â”€â”€ Exercise change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                exSel && exSel.addEventListener('change', () => {
                    exLabel.textContent = exSel.options[exSel.selectedIndex].text;
                    // Reset backend state
                    fetch('/pose_reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{"track_id":0}' }).catch(() => { });
                    repsLarge.textContent = '0';
                    repCount.textContent = '0';
                    prevReps = 0;
                    speak('Switched to ' + exSel.options[exSel.selectedIndex].text);
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SECURITY CAMERA (Tab 8)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initSecurityCam() {
                const video = $('#secVideo'), canvas = $('#secCanvas');
                const startBtn = $('#btnSecStart'), stopBtn = $('#btnSecStop'), posterBtn = $('#btnSecPoster');
                const alertBadge = $('#secAlertBadge'), detectEl = $('#secDetections'), alertLog = $('#secAlertLog');
                const posterModal = $('#secPosterModal'), posterText = $('#secPosterText');
                if (!startBtn) return;
                let stream = null, ivSec = null, lastAlertKey = 'clear', lastFrameB64 = '';
                const ALERT_COLORS = { clear: '#22c55e', caution: '#f59e0b', alert: '#ef4444', critical: '#dc2626' };
                function captureFrame(v) {
                    const off = document.createElement('canvas');
                    off.width = v.videoWidth || 320; off.height = v.videoHeight || 240;
                    off.getContext('2d').drawImage(v, 0, 0, off.width, off.height);
                    return off.toDataURL('image/jpeg', 0.7).split(',')[1] || '';
                }
                function drawBoxes(dets) {
                    if (!canvas || !video.videoWidth) return;
                    canvas.width = video.clientWidth; canvas.height = video.clientHeight;
                    const ctx = canvas.getContext('2d');
                    const sx = canvas.width / (video.videoWidth || 1), sy = canvas.height / (video.videoHeight || 1);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    dets.forEach(d => {
                        const [x1, y1, x2, y2] = d.bbox || [0, 0, 0, 0];
                        const col = d.label === 'person' ? '#22c55e' : '#ef4444';
                        ctx.strokeStyle = col; ctx.lineWidth = 2; ctx.fillStyle = col; ctx.font = '12px Inter';
                        ctx.strokeRect(x1 * sx, y1 * sy, (x2 - x1) * sx, (y2 - y1) * sy);
                        ctx.fillText(`${d.label} ${Math.round((d.conf || 0) * 100)}%`, x1 * sx + 4, y1 * sy + 14);
                    });
                }
                async function secAnalyze() {
                    lastFrameB64 = captureFrame(video);
                    if (!lastFrameB64) return;
                    try {
                        const r = await fetch('/security_analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame_b64: lastFrameB64 }) });
                        if (!r.ok) return;
                        const d = await r.json();
                        const col = ALERT_COLORS[d.alert] || '#5a5f6e';
                        alertBadge.style.color = col; alertBadge.style.borderColor = col + '44'; alertBadge.style.background = col + '11';
                        alertBadge.textContent = d.alert_label || 'UNKNOWN';
                        if (d.alert !== lastAlertKey && (d.alert === 'alert' || d.alert === 'critical')) {
                            document.body.style.outline = '3px solid #ef4444';
                            setTimeout(() => document.body.style.outline = '', 350);
                            if (window.speechSynthesis) { const u = new SpeechSynthesisUtterance((d.alert_message || '').replace(/[âš ï¸âš¡ğŸ‘¤]/g, '')); u.lang = 'en-US'; u.rate = 1.1; speechSynthesis.cancel(); speechSynthesis.speak(u); }
                            alertLog.innerHTML = `<div style="color:#ef4444">${new Date().toLocaleTimeString()}: ${d.alert_message || ''}</div>` + alertLog.innerHTML;
                        }
                        lastAlertKey = d.alert;
                        detectEl.innerHTML = d.detections && d.detections.length ? d.detections.map(x => `<div>${x.label} <span style="color:var(--text-muted)">${Math.round((x.conf || 0) * 100)}%</span></div>`).join('') : '<em style="color:var(--text-muted)">No threats detected</em>';
                        drawBoxes(d.detections || []);
                    } catch (e) { console.warn('sec err', e); }
                }
                startBtn.addEventListener('click', async () => {
                    try { stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 640 } }, audio: false }); video.srcObject = stream; await video.play(); startBtn.disabled = true; stopBtn.disabled = false; ivSec = setInterval(secAnalyze, 1000); toast('ğŸ›¡ï¸ Security Camera active!', 'success'); } catch (e) { toast('Camera error: ' + e.message, 'error'); }
                });
                stopBtn.addEventListener('click', () => { if (ivSec) { clearInterval(ivSec); ivSec = null; } if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } startBtn.disabled = false; stopBtn.disabled = true; });
                posterBtn.addEventListener('click', async () => {
                    if (!lastFrameB64) { toast('Start camera first', 'error'); return; }
                    posterBtn.textContent = 'â³ Generatingâ€¦'; posterBtn.disabled = true;
                    try { const r = await fetch('/wanted_poster', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame_b64: lastFrameB64, description: '' }) }); const d = await r.json(); posterText.textContent = d.poster_text || 'Could not generate.'; posterModal.style.display = 'block'; } catch (e) { toast('Poster error', 'error'); }
                    posterBtn.textContent = 'ğŸ–¼ï¸ Wanted Poster'; posterBtn.disabled = false;
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHARACTER CHAT (Tab 9)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initCharacterChat() {
                const pGrid = $('#personaGrid'), charAvatar = $('#charAvatar'), charNameEl = $('#charName'), charTitleEl = $('#charTitle');
                const msgs = $('#charMessages'), charInput = $('#charInput'), sendBtn = $('#btnCharSend'), resetBtn = $('#btnCharReset'), micBtn = $('#btnCharMic'), ttsChk = $('#charTtsToggle');
                if (!sendBtn) return;
                let activePers = 'companion', sessId = 'char_' + Date.now(), allPersonas = [];
                (async () => {
                    try {
                        const r = await fetch('/personas'); const d = await r.json(); allPersonas = d.personas || []; pGrid.innerHTML = '';
                        allPersonas.forEach(p => {
                            const btn = document.createElement('button');
                            btn.style.cssText = `padding:7px 13px;border-radius:20px;border:1px solid ${p.color}44;background:${p.color}11;color:${p.color};font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:inherit`;
                            btn.textContent = `${p.avatar_emoji} ${p.name}`;
                            btn.addEventListener('click', () => {
                                activePers = p.key; charAvatar.textContent = p.avatar_emoji; charAvatar.style.borderColor = p.color + '44'; charAvatar.style.background = p.color + '11';
                                charNameEl.textContent = p.name; charNameEl.style.color = p.color; charTitleEl.textContent = p.title;
                                $$('#personaGrid button').forEach(b => { b.style.fontWeight = '500'; b.style.borderColor = b.dataset.color + '44'; });
                                btn.style.fontWeight = '800'; btn.style.borderColor = p.color; btn.dataset.color = p.color;
                            }); btn.dataset.color = p.color || '#a855f7'; pGrid.appendChild(btn);
                        });
                        pGrid.querySelector('button')?.click();
                    } catch (e) { pGrid.innerHTML = '<em style="color:var(--text-muted)">Failed to load personas</em>'; }
                })();
                function addMsg(role, text, color) {
                    if (msgs.querySelector('em')) msgs.innerHTML = '';
                    const d = document.createElement('div');
                    d.style.cssText = `padding:9px 13px;border-radius:12px;font-size:13px;line-height:1.6;max-width:86%;white-space:pre-wrap;${role === 'user' ? 'align-self:flex-end;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.2);color:var(--text-primary)' : 'align-self:flex-start;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:' + (color || '#a855f7') + 'cc'}`;
                    d.textContent = text; msgs.appendChild(d); msgs.scrollTop = msgs.scrollHeight;
                }
                async function sendMsg() {
                    const msg = charInput.value.trim(); if (!msg) return;
                    addMsg('user', msg, '#6366f1'); charInput.value = ''; sendBtn.disabled = true;
                    const pers = allPersonas.find(p => p.key === activePers);
                    try {
                        const r = await fetch('/character_chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ persona: activePers, message: msg, session_id: sessId }) }); const d = await r.json();
                        addMsg('assistant', d.response, pers?.color || '#a855f7');
                        if (ttsChk?.checked && window.speechSynthesis) { const u = new SpeechSynthesisUtterance(d.response.replace(/[*_`#]/g, '').substring(0, 180)); u.lang = 'en-US'; u.rate = 0.95; u.pitch = 1.0; speechSynthesis.cancel(); speechSynthesis.speak(u); }
                        charAvatar.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.08)' }, { transform: 'scale(1)' }], { duration: 400 });
                    }
                    catch (e) { addMsg('assistant', 'Connection error', '#ef4444'); }
                    sendBtn.disabled = false; charInput.focus();
                }
                sendBtn.addEventListener('click', sendMsg);
                charInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } });
                resetBtn.addEventListener('click', async () => { sessId = 'char_' + Date.now(); msgs.innerHTML = '<em style="color:var(--text-muted);font-size:13px;margin:auto">Session reset. Say something!</em>'; await fetch('/character_reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessId }) }).catch(() => { }); });
                micBtn.addEventListener('click', () => {
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const recog = new SR(); recog.lang = 'en-US'; recog.interimResults = false;
                        micBtn.textContent = 'ğŸ”´'; micBtn.style.background = 'rgba(239,68,68,0.3)';
                        recog.onresult = e => { charInput.value = e.results[0][0].transcript; micBtn.textContent = 'ğŸ¤'; micBtn.style.background = 'rgba(168,85,247,0.1)'; };
                        recog.onerror = () => { micBtn.textContent = 'ğŸ¤'; micBtn.style.background = 'rgba(168,85,247,0.1)'; };
                        recog.onend = () => { micBtn.textContent = 'ğŸ¤'; micBtn.style.background = 'rgba(168,85,247,0.1)'; };
                        recog.start();
                    } else { toast('Speech recognition not supported in this browser', 'error'); }
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CROWD MONITOR (Tab 10)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initCrowdMonitor() {
                const video = $('#crowdVideo'), canvas = $('#crowdCanvas');
                const startBtn = $('#btnCrowdStart'), stopBtn = $('#btnCrowdStop');
                const safetyBadge = $('#crowdSafetyBadge'), crowdCountEl = $('#crowdCount');
                const scoreNum = $('#crowdScoreNum'), scoreBar = $('#crowdScoreBar');
                const heatmapCanvas = $('#crowdHeatmap'), crowdLog = $('#crowdLog');
                if (!startBtn) return;
                let stream = null, ivCrowd = null;
                function captureFrame(v) { const off = document.createElement('canvas'); off.width = v.videoWidth || 320; off.height = v.videoHeight || 240; off.getContext('2d').drawImage(v, 0, 0, off.width, off.height); return off.toDataURL('image/jpeg', 0.7).split(',')[1] || ''; }
                function renderHeatmap(heatmap, dims) {
                    if (!heatmapCanvas || !heatmap) return;
                    const ctx = heatmapCanvas.getContext('2d'); const { w, h } = dims || { w: 10, h: 8 };
                    heatmapCanvas.width = w; heatmapCanvas.height = h;
                    for (let gy = 0; gy < h; gy++)for (let gx = 0; gx < w; gx++) { const v = (heatmap[gy] || [])[gx] || 0; ctx.fillStyle = `rgba(${Math.round(v * 255)},${Math.round((1 - v) * 80)},0,${0.3 + v * 0.7})`; ctx.fillRect(gx, gy, 1, 1); }
                }
                async function crowdAnalyze() {
                    const frame_b64 = captureFrame(video); if (!frame_b64) return;
                    try {
                        const r = await fetch('/crowd_analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame_b64 }) }); if (!r.ok) return; const d = await r.json();
                        crowdCountEl.textContent = d.person_count || 0; scoreNum.textContent = d.safety_score ?? 'â€”'; scoreNum.style.color = d.safety_color || '#22c55e';
                        scoreBar.style.width = (d.safety_score || 0) + '%'; scoreBar.style.background = `linear-gradient(90deg,${d.safety_color || '#22c55e'},${d.safety_color || '#10b981'})`;
                        safetyBadge.textContent = d.safety_label || 'SAFE'; safetyBadge.style.color = d.safety_color || '#22c55e'; safetyBadge.style.borderColor = (d.safety_color || '#22c55e') + '44';
                        renderHeatmap(d.heatmap, d.heatmap_dims);
                        crowdLog.innerHTML = `<div>${new Date().toLocaleTimeString()}: ${d.person_count || 0} people â€” ${d.safety_label || 'OK'}</div>` + crowdLog.innerHTML.slice(0, 300);
                    } catch (e) { console.warn('crowd err', e); }
                }
                startBtn.addEventListener('click', async () => { try { stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 640 } }, audio: false }); video.srcObject = stream; await video.play(); startBtn.disabled = true; stopBtn.disabled = false; ivCrowd = setInterval(crowdAnalyze, 1500); toast('ğŸ‘¥ Crowd Monitor active!', 'success'); } catch (e) { toast('Camera error: ' + e.message, 'error'); } });
                stopBtn.addEventListener('click', () => { if (ivCrowd) { clearInterval(ivCrowd); ivCrowd = null; } if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } startBtn.disabled = false; stopBtn.disabled = true; });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // GAMING COMPANION (Tab 11)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initGamingCompanion() {
                const fileInput = $('#gamingFileInput'), uploadBtn = $('#btnGamingUpload');
                const analyzeBtn = $('#btnGamingAnalyze'), gameTypeEl = $('#gameType');
                const preview = $('#gamingPreview'), placeholder = $('#gamingPreviewPlaceholder');
                const adviceEl = $('#gamingAdvice'), latencyEl = $('#gamingLatency');
                const historyEl = $('#gamingHistory'), contextInput = $('#gamingContext'), ttsChk = $('#gamingTts');
                if (!uploadBtn) return;
                let currentB64 = '';
                uploadBtn.addEventListener('click', () => fileInput?.click());
                fileInput?.addEventListener('change', e => {
                    const file = e.target.files?.[0]; if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => { preview.src = ev.target.result; preview.style.display = 'block'; placeholder.style.display = 'none'; currentB64 = ev.target.result.split(',')[1] || ''; analyzeBtn.disabled = false; toast('ğŸ“¸ Screenshot loaded!', 'success'); };
                    reader.readAsDataURL(file);
                });
                analyzeBtn?.addEventListener('click', async () => {
                    if (!currentB64) return; analyzeBtn.textContent = 'â³ Analyzingâ€¦'; analyzeBtn.disabled = true;
                    adviceEl.innerHTML = '<em style="color:var(--text-muted)">AI is analyzing your gameâ€¦</em>';
                    try {
                        const r = await fetch('/gaming_analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ frame_b64: currentB64, game_type: gameTypeEl?.value || 'general', context: contextInput?.value || '' }) });
                        const d = await r.json(); adviceEl.textContent = d.advice || 'No advice generated.'; latencyEl.textContent = `âš¡ ${d.latency_ms || 0}ms via ${d.provider || 'AI'}`;
                        if (ttsChk?.checked && window.speechSynthesis && d.advice) { const u = new SpeechSynthesisUtterance(d.advice.substring(0, 150)); u.lang = 'en-US'; u.rate = 1.1; u.pitch = 1.1; speechSynthesis.cancel(); speechSynthesis.speak(u); }
                        const entry = document.createElement('div'); entry.style.cssText = 'border-bottom:1px solid rgba(255,255,255,0.06);padding:6px 0;margin-bottom:4px'; entry.innerHTML = `<div style="font-size:10px;color:var(--text-muted)">${new Date().toLocaleTimeString()} â€” ${gameTypeEl?.value || 'general'}</div><div>${(d.advice || '').substring(0, 80)}â€¦</div>`;
                        if (historyEl.querySelector('em')) historyEl.innerHTML = ''; historyEl.prepend(entry);
                        toast('ğŸ® Gaming advice ready!', 'success');
                    }
                    catch (e) { adviceEl.textContent = 'Error: ' + e.message; toast('Error: ' + e.message, 'error'); }
                    analyzeBtn.textContent = 'ğŸ”¬ Analyze'; analyzeBtn.disabled = false;
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PERFORMANCE DASHBOARD (Tab 12)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initDashboard() {
                const metricGrid = $('#dashMetricGrid'), cascadeEl = $('#dashCascade');
                const samplerEl = $('#dashSampler'), sessionEl = $('#dashSession');
                const latencyCanvas = $('#latencyChart'), refreshBtn = $('#btnDashRefresh');
                if (!metricGrid) return;
                const latHist = [];
                function mkMetric(label, val, color) { return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:14px;text-align:center"><div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">${label}</div><div style="font-size:24px;font-weight:800;color:${color}">${val}</div></div>`; }
                function drawChart(data) {
                    if (!latencyCanvas) return;
                    const ctx = latencyCanvas.getContext('2d');
                    latencyCanvas.width = latencyCanvas.clientWidth || 280; latencyCanvas.height = 100;
                    const W = latencyCanvas.width, H = latencyCanvas.height;
                    ctx.clearRect(0, 0, W, H); if (data.length < 2) return;
                    const maxVal = Math.max(...data, 200);
                    ctx.strokeStyle = 'rgba(99,102,241,0.2)'; ctx.lineWidth = 1;
                    [0.25, 0.5, 0.75, 1].forEach(f => { const y = H - f * H; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.font = '9px monospace'; ctx.fillText(Math.round(maxVal * f) + 'ms', 2, y - 2); });
                    ctx.beginPath(); ctx.strokeStyle = '#6366f1'; ctx.lineWidth = 2;
                    data.forEach((v, i) => { const x = (i / (data.length - 1)) * W; const y = H - (v / maxVal) * H * 0.88; i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); }); ctx.stroke();
                    const firstX = 0, firstY = H - (data[0] / maxVal) * H * 0.88;
                    const lastX = W, lastY = H - (data[data.length - 1] / maxVal) * H * 0.88;
                    const grad = ctx.createLinearGradient(0, 0, 0, H); grad.addColorStop(0, 'rgba(99,102,241,0.25)'); grad.addColorStop(1, 'rgba(99,102,241,0)');
                    ctx.lineTo(lastX, H); ctx.lineTo(firstX, H); ctx.lineTo(firstX, firstY); ctx.closePath(); ctx.fillStyle = grad; ctx.fill();
                }
                async function loadMetrics() {
                    try {
                        const t0 = performance.now(); const r = await fetch('/metrics'); if (!r.ok) return; const d = await r.json();
                        const lat = Math.round(performance.now() - t0); latHist.push(lat); if (latHist.length > 30) latHist.shift(); drawChart(latHist);
                        const upm = Math.floor((d.uptime_seconds || 0) / 60);
                        metricGrid.innerHTML = mkMetric('Uptime', upm + 'm', '#22c55e') + mkMetric('Pose Frames', d.pose_frames_processed || 0, '#10b981') + mkMetric('Security Frames', d.security_frames_processed || 0, '#ef4444') + mkMetric('Char Chats', d.character_chats || 0, '#a855f7') + mkMetric('Crowd Frames', d.crowd_frames_processed || 0, '#f59e0b') + mkMetric('Gaming', d.gaming_analyses || 0, '#06b6d4') + mkMetric('STT Calls', d.stt_calls || 0, '#3b82f6') + mkMetric('API Latency', lat + 'ms', lat < 200 ? '#22c55e' : lat < 500 ? '#f59e0b' : '#ef4444');
                        cascadeEl.innerHTML = '';
                        const cascade = d.llm_cascade || [];
                        if (cascade.length) { cascade.forEach((p, i) => { const div = document.createElement('div'); div.style.cssText = 'display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;font-size:12px' + (i === 0 ? ';background:rgba(99,102,241,0.08)' : ''); div.innerHTML = `<span style="color:#22c55e;font-weight:700">${i === 0 ? 'â–¶' : 'â€¢'}</span><span style="color:var(--text-secondary)">${p.display || p.name}</span><span style="color:var(--text-muted);margin-left:auto;font-size:10px">${p.model || ''}</span>`; cascadeEl.appendChild(div); }); }
                        else { cascadeEl.innerHTML = `<div style="font-size:13px;color:#a855f7;font-weight:600">${d.active_provider || 'Unknown'}</div>`; }
                        const s = d.frame_sampler || {};
                        samplerEl.innerHTML = `<div>Received: <strong>${s.total_received || 0}</strong></div><div>Sent to AI: <strong>${s.total_sent || 0}</strong></div><div>Efficiency: <strong style="color:#22c55e">${s.efficiency_pct || 0}%</strong></div><div>Skipped (motion): <strong>${s.total_skipped || 0}</strong></div>`;
                        sessionEl.innerHTML = `<div>Uptime: <strong>${d.uptime_seconds || 0}s</strong></div><div>Total requests: <strong>${d.total_requests || 0}</strong></div><div>Active tracked: <strong style="color:#06b6d4">${d.active_tracker_objects || 0}</strong></div><div>Server: <strong style="color:#a855f7">${d.server || 'vision-agent'}</strong></div>`;
                    } catch (e) { console.warn('metrics err', e); }
                }
                loadMetrics();
                $('#tabDashboard')?.addEventListener('click', loadMetrics);
                refreshBtn?.addEventListener('click', loadMetrics);
                setInterval(() => { if ($('#panelDashboard.active')) loadMetrics(); }, 10000);
            })();

            // â”€â”€ Logo eye blink â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            (function setupLogoBlink() {
                const logo = $('#logoEl');
                if (!logo) return;
                const eyelid = logo.querySelector('.logo-eye');
                if (!eyelid) return;

                function blink() {
                    eyelid.animate(
                        [{ opacity: 0 }, { opacity: 1 }, { opacity: 1 }, { opacity: 0 }],
                        { duration: 220, easing: 'ease-in-out' }
                    );
                    const next = 5000 + Math.random() * 5000;
                    setTimeout(blink, next);
                }
                setTimeout(blink, 2000);

                // Quick blink on hover
                logo.addEventListener('mouseenter', () => {
                    eyelid.animate(
                        [{ opacity: 0 }, { opacity: 1 }, { opacity: 0 }],
                        { duration: 150, easing: 'ease' }
                    );
                });
            })();

            // â”€â”€ Button ripple/glow effect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            document.addEventListener('mousemove', e => {
                const btn = e.target.closest('.btn');
                if (btn) {
                    const r = btn.getBoundingClientRect();
                    btn.style.setProperty('--x', ((e.clientX - r.left) / r.width * 100) + '%');
                    btn.style.setProperty('--y', ((e.clientY - r.top) / r.height * 100) + '%');
                }
            });

            // â”€â”€ Sparkle burst (reusable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function sparkle(x, y, count = 8) {
                const c = document.createElement('div');
                c.className = 'sparkle-container';
                c.style.left = x + 'px'; c.style.top = y + 'px';
                for (let i = 0; i < count; i++) {
                    const s = document.createElement('div');
                    s.className = 'sparkle';
                    const angle = (Math.PI * 2 * i) / count;
                    const dist = 20 + Math.random() * 30;
                    s.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                    s.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                    s.style.background = ['#6366f1', '#8b5cf6', '#a855f7', '#22c55e', '#fff'][Math.floor(Math.random() * 5)];
                    s.style.width = (3 + Math.random() * 5) + 'px';
                    s.style.height = s.style.width;
                    c.appendChild(s);
                }
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 1000);
            }

            // â”€â”€ Drop Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const dz = $('#dropzone');
            const fi = $('#fileInput');
            let selectedFile = null;

            dz.addEventListener('click', () => fi.click());
            dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
            dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
            dz.addEventListener('drop', e => {
                e.preventDefault(); dz.classList.remove('dragover');
                if (e.dataTransfer.files.length) { selectedFile = e.dataTransfer.files[0]; onFileSelected(); }
            });
            fi.addEventListener('change', () => { if (fi.files.length) { selectedFile = fi.files[0]; onFileSelected(); } });

            function onFileSelected() {
                dz.querySelector('.dropzone-text').textContent = selectedFile.name;
                dz.querySelector('.dropzone-sub').textContent =
                    `${(selectedFile.size / (1024 * 1024)).toFixed(1)} MB â€” ready to upload`;
                $('#btnUpload').disabled = false;
                $('#btnAnalyze').disabled = false;
            }

            // â”€â”€ Upload / Analyze (real XHR progress) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function doUpload(endpoint) {
                if (!selectedFile) return;
                const fd = new FormData();
                fd.append('file', selectedFile);
                const pa = $('#progressArea');
                pa.classList.add('visible');
                $('#progressBar').style.width = '0%';
                $('#progressBar').style.background = 'var(--gradient-main)';
                $('#progressLabel').textContent = 'Uploadingâ€¦';
                $('#progressPct').textContent = '0%';
                $('#btnUpload').disabled = true;
                $('#btnAnalyze').disabled = true;

                const xhr = new XMLHttpRequest();
                xhr.open('POST', endpoint, true);

                // Real upload progress from XHR
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        // Upload phase = 0-50% of total bar, server processing = 50-100%
                        const barPct = Math.round(pct * 0.5);
                        $('#progressBar').style.width = barPct + '%';
                        $('#progressPct').textContent = barPct + '%';
                        if (pct >= 100) {
                            $('#progressLabel').textContent = endpoint === '/upload' ? 'Extracting framesâ€¦' : 'Analyzing (frames + audio + detection)â€¦';
                        }
                    }
                };

                // Upload complete, now waiting for server response
                xhr.upload.onload = () => {
                    $('#progressBar').style.width = '50%';
                    $('#progressPct').textContent = '50%';
                    $('#progressLabel').textContent = endpoint === '/upload' ? 'Server processingâ€¦' : 'Server analyzing (this may take a minute)â€¦';
                    // Animate from 50% to 95% slowly while server works
                    let fakePct = 50;
                    window._serverWaitInterval = setInterval(() => {
                        fakePct = Math.min(fakePct + Math.random() * 2, 95);
                        $('#progressBar').style.width = fakePct + '%';
                        $('#progressPct').textContent = Math.round(fakePct) + '%';
                    }, 800);
                };

                xhr.onload = () => {
                    clearInterval(window._serverWaitInterval);
                    try {
                        const data = JSON.parse(xhr.responseText);
                        $('#progressBar').style.width = '100%';
                        $('#progressPct').textContent = '100%';
                        if (data.ok && data.warnings && data.warnings.length) {
                            $('#progressLabel').textContent = 'Complete with warnings âš ï¸';
                            $('#progressBar').style.background = 'linear-gradient(135deg, #f59e0b, #eab308)';
                        } else {
                            $('#progressLabel').textContent = data.ok ? 'Complete âœ“' : 'Error';
                            if (!data.ok) $('#progressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        }
                        displayResults(data, endpoint);
                        if (data.ok) {
                            toast('Processing complete!', 'success');
                            if (data.video_stem) {
                                window._lastVideoStem = data.video_stem;
                                $('#noteStem').value = data.video_stem;
                                $('#notesStemHint').style.display = 'block';
                                $('#notesNoAnalysis').style.display = 'none';
                            }
                        } else {
                            toast('Error: ' + (data.error || 'Unknown error'), 'error');
                        }
                        if (data.warnings) {
                            data.warnings.forEach(w => toast('âš ï¸ ' + w, 'error'));
                        }
                    } catch (parseErr) {
                        $('#progressLabel').textContent = 'Failed (server error)';
                        $('#progressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        toast('Server error: ' + xhr.statusText, 'error');
                    }
                    $('#btnUpload').disabled = false;
                    $('#btnAnalyze').disabled = false;
                };

                xhr.onerror = () => {
                    clearInterval(window._serverWaitInterval);
                    $('#progressLabel').textContent = 'Network error';
                    $('#progressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    toast('Network error â€” check if server is running', 'error');
                    $('#btnUpload').disabled = false;
                    $('#btnAnalyze').disabled = false;
                };

                xhr.ontimeout = () => {
                    clearInterval(window._serverWaitInterval);
                    $('#progressLabel').textContent = 'Timed out';
                    $('#progressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    toast('Request timed out â€” try a shorter video', 'error');
                    $('#btnUpload').disabled = false;
                    $('#btnAnalyze').disabled = false;
                };

                xhr.timeout = 300000; // 5 minute timeout
                xhr.send(fd);
            }

            $('#btnUpload').addEventListener('click', () => doUpload('/upload'));
            $('#btnAnalyze').addEventListener('click', () => doUpload('/analyze'));

            function displayResults(data, endpoint) {
                window._lastAnalysisData = data; // cache for export
                const area = $('#uploadResults');
                area.style.display = 'block';

                // Metrics
                const mg = $('#metricsGrid');
                mg.innerHTML = '';
                const metrics = [
                    { label: 'Frames', value: data.frames_count ?? 'â€”' },
                ];
                if (data.frames_time_seconds !== undefined)
                    metrics.push({ label: 'Frame Time', value: data.frames_time_seconds + 's' });
                if (data.transcription_time_seconds !== undefined)
                    metrics.push({ label: 'Transcribe', value: data.transcription_time_seconds + 's' });
                if (data.detection_time_seconds !== undefined)
                    metrics.push({ label: 'Detection', value: data.detection_time_seconds + 's' });
                if (data.total_time_seconds !== undefined)
                    metrics.push({ label: 'Total', value: data.total_time_seconds + 's' });
                metrics.forEach(m => {
                    mg.innerHTML += `<div class="metric"><div class="metric-value">${m.value}</div><div class="metric-label">${m.label}</div></div>`;
                });

                // Transcript
                if (data.transcript && data.transcript.text) {
                    $('#transcriptSection').style.display = 'block';
                    $('#transcriptText').textContent = data.transcript.text;
                } else {
                    $('#transcriptSection').style.display = 'none';
                }

                // Detections
                if (data.detections_summary) {
                    $('#detectionsSection').style.display = 'block';
                    $('#detectionsText').textContent = JSON.stringify(data.detections_summary, null, 2);
                } else {
                    $('#detectionsSection').style.display = 'none';
                }

                // Raw JSON
                $('#rawJson').textContent = JSON.stringify(data, null, 2);
            }

            // Wire export buttons
            $('#btnExportAnalysis').addEventListener('click', () => {
                const d = window._lastAnalysisData;
                if (!d) { toast('No analysis data yet â€” run Full Analysis first', 'error'); return; }
                downloadJSON(d, `analysis_${d.video_stem || 'video'}.json`);
            });
            $('#btnExportTranscript').addEventListener('click', () => {
                const d = window._lastAnalysisData;
                if (!d) { toast('No analysis data yet â€” run Full Analysis first', 'error'); return; }
                downloadJSON(d.transcript || {}, `transcript_${d.video_stem || 'video'}.json`);
            });
            $('#btnExportDetections').addEventListener('click', () => {
                const d = window._lastAnalysisData;
                if (!d) { toast('No analysis data yet â€” run Full Analysis first', 'error'); return; }
                downloadJSON(d.detections_summary || {}, `detections_${d.video_stem || 'video'}.json`);
            });

            // â”€â”€ Notes Generation (Async Job Flow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            $('#btnNotes').addEventListener('click', async () => {
                const stem = $('#noteStem').value.trim() || 'video';
                const btn = $('#btnNotes');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Startingâ€¦';

                try {
                    // Step 1: POST to start the notes job
                    const resp = await fetch(`/generate_notes?video_stem=${encodeURIComponent(stem)}`, { method: 'POST' });
                    const data = await resp.json();

                    if (data.detail) throw new Error(data.detail);
                    if (!data.ok || !data.job_id) throw new Error(data.error || 'Failed to start notes job');

                    const jobId = data.job_id;
                    btn.innerHTML = '<span class="spinner"></span> Generatingâ€¦';

                    // Step 2: Poll for progress
                    pollJob(jobId,
                        // onUpdate
                        (job) => {
                            const pct = job.progress || 0;
                            btn.innerHTML = `<span class="spinner"></span> ${job.step || 'Generatingâ€¦'} (${pct}%)`;
                        },
                        // onDone
                        async (job) => {
                            const result = job.result || {};
                            try {
                                // Fetch the saved notes.json from the server
                                const notesResp = await fetch(`/analysis/${encodeURIComponent(result.video_stem || stem)}/notes.json`);
                                if (notesResp.ok) {
                                    const notes = await notesResp.json();
                                    displayNotes(notes);
                                } else {
                                    displayNotes(result);
                                }
                            } catch (e) {
                                displayNotes(result);
                            }

                            // Show provider badge
                            const provName = result.llm_provider || 'unknown';
                            const isFallback = result.is_fallback;
                            let badge = '';
                            if (isFallback) {
                                badge = `<span style="display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(234,179,8,0.15);color:#eab308;border:1px solid rgba(234,179,8,0.3)">âš  Auto-summary mode</span>`;
                                if (result.warning) badge += ` <span style="font-size:11px;color:var(--text-muted)">${result.warning}</span>`;
                            } else {
                                const pName = provName.charAt(0).toUpperCase() + provName.slice(1);
                                badge = `<span style="display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3)">âœ“ Generated with ${pName}</span>`;
                            }
                            const badgeEl = document.createElement('div');
                            badgeEl.style.marginBottom = '12px';
                            badgeEl.innerHTML = badge;
                            const notesResults = $('#notesResults');
                            if (notesResults && notesResults.firstChild) {
                                notesResults.insertBefore(badgeEl, notesResults.firstChild);
                            }

                            toast('Notes generated successfully!');
                            btn.disabled = false;
                            btn.innerHTML = '<span>âœ¨</span> Generate Notes';
                        },
                        // onFail
                        (job) => {
                            toast('Error: ' + (job.error || 'Notes generation failed'), 'error');
                            btn.disabled = false;
                            btn.innerHTML = '<span>âœ¨</span> Generate Notes';
                        }
                    );

                } catch (err) {
                    toast('Error: ' + err.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span>âœ¨</span> Generate Notes';
                }
            });

            function displayNotes(n) {
                $('#notesResults').style.display = 'block';

                // Summary
                $('#notesSummary').textContent = n.summary || 'â€”';

                // Key concepts
                const tags = $('#notesConceptTags');
                tags.innerHTML = '';
                (n.key_concepts || []).forEach(c => {
                    tags.innerHTML += `<span class="tag">${c}</span>`;
                });

                // Formulas
                const fArea = $('#notesFormulas');
                fArea.innerHTML = '';
                (n.formulas || []).forEach(f => {
                    fArea.innerHTML += `<div class="formula-card">
          <div class="formula-latex">${f.latex || ''}</div>
          <div class="formula-explain">${f.explanation || ''} ${f.timestamp ? `(t=${f.timestamp}s)` : ''}</div>
        </div>`;
                });

                // Viva
                const vArea = $('#notesViva');
                vArea.innerHTML = '';
                const viva = n.viva_questions || {};
                ['easy', 'medium', 'hard'].forEach(level => {
                    if (viva[level] && viva[level].length) {
                        let html = `<div class="question-group ${level}"><h4>${level}</h4>`;
                        viva[level].forEach(q => { html += `<div class="question-item">${q}</div>`; });
                        html += '</div>';
                        vArea.innerHTML += html;
                    }
                });

                // Highlights
                const hArea = $('#notesHighlights');
                hArea.innerHTML = '';
                (n.highlights || []).forEach(h => {
                    hArea.innerHTML += `<div class="highlight-item">
          <div class="highlight-time">${h.timestamp ? h.timestamp + 's' : 'â€”'}</div>
          <div class="highlight-text">${h.text || ''}</div>
        </div>`;
                });

                // Raw
                $('#notesRawJson').textContent = JSON.stringify(n, null, 2);
            }

            // â”€â”€ Live Streaming (Enhanced â€” Bbox + Metrics) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let mediaRecorder = null;
            let webcamStream = null;
            let chunkIdx = 0;
            let totalChunks = 0;
            let totalElapsed = 0;
            let totalDetections = 0;
            let totalFrames = 0;
            let overlayEnabled = true;
            let lastDetections = []; // for canvas drawing
            const videoStem = 'live_' + Date.now();
            const chunkLatencies = [];

            // Bbox color palette (vibrant)
            const BBOX_COLORS = [
                '#6366f1', '#10b981', '#f59e0b', '#ec4899', '#0ea5e9',
                '#a855f7', '#ef4444', '#14b8a6', '#f97316', '#8b5cf6'
            ];
            const labelColorMap = {};
            let colorIdx = 0;
            function getColorForLabel(label) {
                if (!labelColorMap[label]) {
                    labelColorMap[label] = BBOX_COLORS[colorIdx % BBOX_COLORS.length];
                    colorIdx++;
                }
                return labelColorMap[label];
            }

            function addLog(msg) {
                const log = $('#streamLog');
                const t = new Date().toLocaleTimeString();
                log.innerHTML += `<div style="margin-bottom:2px"><span style="color:var(--text-muted)">[${t}]</span> ${msg}</div>`;
                log.scrollTop = log.scrollHeight;
            }

            // â”€â”€ Draw bounding boxes on canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function drawBboxes(perFrameDetections) {
                const canvas = $('#bboxCanvas');
                const video = $('#videoPreview');
                if (!canvas || !video || !overlayEnabled) return;

                const ctx = canvas.getContext('2d');
                // Match canvas resolution to video display
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (!perFrameDetections || perFrameDetections.length === 0) return;

                // Use the last frame's detections (most recent)
                const lastFrame = perFrameDetections[perFrameDetections.length - 1];
                if (!lastFrame || !lastFrame.detections) return;

                lastDetections = lastFrame.detections;

                // We need to scale bbox coords from frame resolution to canvas size
                // YOLO returns absolute pixel coords in the extracted frame (typically 640x480 or similar)
                // We'll estimate frame size from the video element
                const vw = video.videoWidth || 640;
                const vh = video.videoHeight || 480;
                const scaleX = canvas.width / vw;
                const scaleY = canvas.height / vh;

                lastFrame.detections.forEach(det => {
                    if (!det.bbox || det.bbox.length < 4) return;
                    const [x1, y1, x2, y2] = det.bbox;
                    const sx = x1 * scaleX, sy = y1 * scaleY;
                    const sw = (x2 - x1) * scaleX, sh = (y2 - y1) * scaleY;
                    const color = getColorForLabel(det.label);

                    // Draw box
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(sx, sy, sw, sh);

                    // Draw label background
                    const labelText = `${det.label} ${(det.confidence * 100).toFixed(0)}%`;
                    ctx.font = 'bold 11px "Inter", sans-serif';
                    const tm = ctx.measureText(labelText);
                    const lh = 16;
                    ctx.fillStyle = color;
                    ctx.fillRect(sx, sy - lh - 2, tm.width + 8, lh + 2);

                    // Draw label text
                    ctx.fillStyle = '#fff';
                    ctx.fillText(labelText, sx + 4, sy - 4);
                });
            }

            // â”€â”€ Update metrics dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function updateStreamMetrics(latencyMs) {
                if (latencyMs != null) chunkLatencies.push(latencyMs);
                const el = (id) => document.getElementById(id);

                el('metricChunks').textContent = totalChunks;
                el('metricFrames').textContent = totalFrames;
                el('metricObjects').textContent = totalDetections;

                if (chunkLatencies.length > 0) {
                    const avg = chunkLatencies.reduce((a, b) => a + b, 0) / chunkLatencies.length;
                    el('metricLatency').textContent = (avg / 1000).toFixed(2) + 's';

                    const sorted = [...chunkLatencies].sort((a, b) => a - b);
                    const p90Idx = Math.min(Math.floor(sorted.length * 0.9), sorted.length - 1);
                    el('metricP90').textContent = (sorted[p90Idx] / 1000).toFixed(2) + 's';

                    const fps = avg > 0 ? (1000 / avg).toFixed(1) : 'â€”';
                    el('metricFPS').textContent = fps;
                }
            }

            // â”€â”€ Update live label badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function updateLiveLabels(topLabels) {
                const container = $('#liveLabels');
                if (!container || !topLabels) return;
                container.innerHTML = '';
                topLabels.forEach(l => {
                    const color = getColorForLabel(l.label);
                    container.innerHTML += `<span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;background:${color}22;color:${color};border:1px solid ${color}44;cursor:pointer" onclick="askAboutLabel('${l.label}')">${l.label} Ã—${l.count}</span>`;
                });
            }

            // â”€â”€ Ask agent about a label (2-Tier: Fast + Polish) â”€â”€â”€â”€â”€â”€â”€â”€â”€
            window.askAboutLabel = async function (label) {
                const panel = $('#agentResponse');
                if (!panel) return;

                const question = `What can you tell me about the "${label}" detected in this video? What is it doing and what context can you provide?`;
                panel.innerHTML = `<span style="color:var(--accent-1)">ğŸ¤– Asking about "${label}"...</span>`;

                try {
                    const resp = await fetch('/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_stem: videoStem, question })
                    });
                    const data = await resp.json();

                    // Show FastReply immediately (green badge)
                    if (data.fast_reply) {
                        const fr = data.fast_reply;
                        let provHtml = '';
                        if (fr.provenance && fr.provenance.length) {
                            provHtml = fr.provenance.map(p =>
                                `<span style="display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;background:rgba(99,102,241,0.1);color:var(--accent-1);margin-left:4px">${p.type}: ${p.detail}</span>`
                            ).join('');
                        }
                        panel.innerHTML = `
                        <div style="margin-bottom:8px">
                            <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:rgba(16,185,129,0.15);color:#10b981;margin-bottom:4px">âš¡ Fast Reply (${fr.latency_ms}ms)</span>
                            ${provHtml}
                        </div>
                        <div style="font-size:13px;line-height:1.5">${fr.reply}</div>
                    `;
                    }

                    // Poll for PolishReply
                    if (data.job_id) {
                        const jobId = data.job_id;
                        const pollInterval = setInterval(async () => {
                            try {
                                const jr = await fetch(`/jobs/${jobId}`);
                                const job = await jr.json();
                                if (job.status === 'done' && job.result) {
                                    clearInterval(pollInterval);
                                    const pr = job.result;
                                    let provHtml = '';
                                    if (pr.provenance && pr.provenance.length) {
                                        provHtml = pr.provenance.map(p =>
                                            `<span style="display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;background:rgba(168,85,247,0.1);color:#a855f7;margin-left:4px">${p.type}: ${p.detail}</span>`
                                        ).join('');
                                    }
                                    panel.innerHTML += `
                                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1)">
                                        <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:rgba(168,85,247,0.15);color:#a855f7;margin-bottom:4px">ğŸ§  ${pr.source === 'fallback' ? 'Fallback' : 'AI Polish'} ${pr.provider || ''}</span>
                                        ${provHtml}
                                        <div style="font-size:13px;line-height:1.5;margin-top:4px">${pr.reply}</div>
                                    </div>
                                `;
                                } else if (job.status === 'failed') {
                                    clearInterval(pollInterval);
                                    panel.innerHTML += `<div style="margin-top:6px;color:#ef4444;font-size:12px">âš ï¸ ${job.error || 'LLM polish failed'}</div>`;
                                }
                            } catch (e) { /* silently retry */ }
                        }, 2000);
                        // Stop polling after 30s
                        setTimeout(() => clearInterval(pollInterval), 30000);
                    }
                } catch (err) {
                    panel.innerHTML = `<span style="color:#ef4444">âŒ Agent error: ${err.message}</span>`;
                }
            };

            // â”€â”€ Toggle overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            $('#btnToggleOverlay').addEventListener('click', () => {
                overlayEnabled = !overlayEnabled;
                $('#btnToggleOverlay').textContent = overlayEnabled ? 'ğŸ¯ Overlay: ON' : 'ğŸ¯ Overlay: OFF';
                if (!overlayEnabled) {
                    const canvas = $('#bboxCanvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }
            });

            // â”€â”€ Start stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            $('#btnStartStream').addEventListener('click', async () => {
                try {
                    webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    $('#videoPreview').srcObject = webcamStream;

                    let mimeType = 'video/webm;codecs=vp8,opus';
                    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';

                    mediaRecorder = new MediaRecorder(webcamStream, { mimeType });
                    chunkIdx = 0; totalChunks = 0; totalElapsed = 0; totalDetections = 0; totalFrames = 0;
                    chunkLatencies.length = 0;
                    $('#streamLog').innerHTML = '';
                    addLog('ğŸŸ¢ Stream started â€” sending 2s chunks with YOLO detection');

                    mediaRecorder.ondataavailable = async (e) => {
                        if (!e.data || e.data.size === 0) return;
                        chunkIdx++;
                        totalChunks++;
                        addLog(`ğŸ“¤ Chunk #${chunkIdx} (${(e.data.size / 1024).toFixed(0)} KB)`);

                        const fd = new FormData();
                        fd.append('video_stem', videoStem);
                        fd.append('chunk_index', chunkIdx);
                        fd.append('total_chunks', 0);
                        fd.append('file', e.data, `chunk_${String(chunkIdx).padStart(3, '0')}.webm`);

                        const t0 = performance.now();
                        try {
                            const resp = await fetch('/stream_chunk', { method: 'POST', body: fd });
                            const j = await resp.json();
                            const ms = Math.round(performance.now() - t0);
                            totalElapsed += ms / 1000;

                            if (j.ok) {
                                totalFrames += j.frames_count || 0;
                                totalDetections += j.detections_count || 0;

                                // Update overlays
                                const latOverlay = $('#latencyOverlay');
                                if (latOverlay) { latOverlay.style.display = 'block'; $('#latencyMs').textContent = j.elapsed_ms || ms; }
                                const detBadge = $('#detCountBadge');
                                if (detBadge && j.detections_count > 0) { detBadge.style.display = 'block'; $('#detCountNum').textContent = j.detections_count; }

                                // Draw bounding boxes
                                if (j.per_frame_detections) drawBboxes(j.per_frame_detections);

                                // Update live labels
                                if (j.top_labels) updateLiveLabels(j.top_labels);

                                addLog(`âœ… #${j.chunk_index} â€” ${j.elapsed_ms}ms server | ${j.frames_count} frames | ${j.detections_count} detections`);
                                if (j.transcript_snippet && j.transcript_snippet.length > 5) {
                                    addLog(`ğŸ™ï¸ "${j.transcript_snippet.slice(0, 100)}"`);
                                }
                            } else {
                                addLog(`âŒ Error: ${j.error}`);
                            }
                        } catch (err) {
                            addLog(`âŒ Network: ${err.message}`);
                        }
                        updateStreamMetrics(performance.now() - t0);
                    };

                    mediaRecorder.start(2000);
                    $('#btnStartStream').disabled = true;
                    $('#btnStopStream').disabled = false;
                    $('#btnFinalize').disabled = true;
                } catch (err) {
                    toast('Webcam access denied: ' + err.message, 'error');
                }
            });

            // â”€â”€ Stop stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            $('#btnStopStream').addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                if (webcamStream) webcamStream.getTracks().forEach(t => t.stop());
                $('#videoPreview').srcObject = null;
                addLog('ğŸ”´ Stream stopped');
                $('#btnStartStream').disabled = false;
                $('#btnStopStream').disabled = true;
                $('#btnFinalize').disabled = false;

                // Fetch final metrics from server
                fetch(`/stream_status?video_stem=${encodeURIComponent(videoStem)}`)
                    .then(r => r.json())
                    .then(status => {
                        if (status.ok) {
                            addLog(`ğŸ“Š Final: ${status.chunks_processed} chunks, ${status.frames_total} frames, avg ${status.avg_chunk_latency_ms}ms/chunk, ${status.total_detections} total detections`);
                            if (status.model_metrics) {
                                const mm = status.model_metrics;
                                addLog(`ğŸ§  Model: ${mm.model} | ${mm.avg_latency_ms}ms avg | ${mm.model_fps} FPS | ${mm.total_inferences} inferences`);
                                const el = (id) => document.getElementById(id);
                                if (mm.model_fps) el('metricFPS').textContent = mm.model_fps;
                            }
                        }
                    }).catch(() => { });
            });

            // â”€â”€ Finalize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            $('#btnFinalize').addEventListener('click', async () => {
                addLog('ğŸ”— Finalizing â€” stitching chunks and running full analysisâ€¦');
                $('#btnFinalize').disabled = true;
                const fd = new FormData();
                fd.append('video_stem', videoStem);
                try {
                    const resp = await fetch('/stream_finalize', { method: 'POST', body: fd });
                    const data = await resp.json();
                    addLog('âœ… Finalize complete â€” see Upload tab for full results');
                    $('#tabUpload').click();
                    displayResults(data, '/analyze');
                    toast('Stream finalized & full analysis ready!');
                } catch (err) {
                    addLog(`âŒ Finalize error: ${err.message}`);
                    toast('Finalize error: ' + err.message, 'error');
                }
            });
            // â”€â”€ URL Ingestion (Async Job Flow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function updateUrlBtn() {
                const url = ($('#urlInput') || {}).value || '';
                const consent = ($('#urlConsent') || {}).checked || false;
                const btn = $('#btnFetchAnalyze');
                if (btn) btn.disabled = !(url.trim().startsWith('http') && consent);
            }
            if ($('#urlInput')) $('#urlInput').addEventListener('input', updateUrlBtn);
            if ($('#urlConsent')) $('#urlConsent').addEventListener('change', updateUrlBtn);

            // Poll a job until done/failed
            function pollJob(jobId, onUpdate, onDone, onFail) {
                const poll = async () => {
                    try {
                        const resp = await fetch(`/jobs/${jobId}`);
                        const job = await resp.json();
                        if (onUpdate) onUpdate(job);

                        if (job.status === 'done') { onDone(job); return; }
                        if (job.status === 'failed') { onFail(job); return; }
                        setTimeout(poll, 2000);
                    } catch (err) {
                        onFail({ error: 'Network error: ' + err.message });
                    }
                };
                setTimeout(poll, 800); // first poll after 800ms
            }

            if ($('#btnFetchAnalyze')) {
                $('#btnFetchAnalyze').addEventListener('click', async () => {
                    const url = $('#urlInput').value.trim();
                    if (!url) return toast('Please enter a URL', 'error');
                    if (!$('#urlConsent').checked) return toast('Please confirm consent', 'error');

                    const btn = $('#btnFetchAnalyze');
                    btn.disabled = true;
                    const pa = $('#urlProgressArea');
                    pa.classList.add('visible');
                    $('#urlProgressBar').style.width = '0%';
                    $('#urlProgressBar').style.background = 'var(--gradient-main)';
                    $('#urlProgressLabel').textContent = 'Starting jobâ€¦';
                    $('#urlProgressPct').textContent = '0%';
                    $('#urlResults').style.display = 'none';

                    try {
                        // Step 1: POST to start the job
                        const startResp = await fetch('/fetch_and_analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-User-Consent': 'true'
                            },
                            body: JSON.stringify({
                                url: url,
                                consent: true,
                                use_captions_if_available: true,
                                max_duration: 900
                            })
                        });
                        const startData = await startResp.json();

                        if (!startData.ok) {
                            $('#urlProgressLabel').textContent = 'Error';
                            $('#urlProgressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                            toast('Error: ' + (startData.error || 'Unknown error'), 'error');
                            btn.disabled = false;
                            updateUrlBtn();
                            return;
                        }

                        const jobId = startData.job_id;
                        $('#urlProgressLabel').textContent = `Job started (${jobId})â€¦`;

                        // Step 2: Poll for progress
                        pollJob(jobId,
                            // onUpdate â€” real progress from server
                            (job) => {
                                const pct = job.progress || 0;
                                $('#urlProgressBar').style.width = pct + '%';
                                $('#urlProgressPct').textContent = pct + '%';
                                $('#urlProgressLabel').textContent = job.step || 'Processingâ€¦';
                            },
                            // onDone
                            (job) => {
                                const r = job.result || {};
                                $('#urlProgressBar').style.width = '100%';
                                $('#urlProgressPct').textContent = '100%';
                                $('#urlProgressLabel').textContent = r.cached ? 'Complete (cached) âœ“' : 'Complete âœ“';

                                const stem = r.analysis_stem || '';
                                let html = `<p><strong>Analysis Stem:</strong> ${stem}</p>`;
                                html += `<p><strong>Source URL:</strong> ${r.source_url || url}</p>`;
                                if (r.transcript_source) html += `<p><strong>Transcript Source:</strong> <span style="color:var(--accent-1)">${r.transcript_source}</span></p>`;
                                if (r.frames_count) html += `<p><strong>Frames Extracted:</strong> ${r.frames_count}</p>`;

                                // LLM provider badge
                                const llmName = r.llm_provider || 'unknown';
                                const isFallback = r.is_fallback;
                                if (isFallback) {
                                    html += `<p><span style="display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(234,179,8,0.15);color:#eab308;border:1px solid rgba(234,179,8,0.3)">âš  No LLM configured (Gemini/OpenAI). Using auto-summary mode.</span></p>`;
                                } else {
                                    const provName = llmName.charAt(0).toUpperCase() + llmName.slice(1);
                                    html += `<p><span style="display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3)">âœ“ Notes generated with ${provName}</span></p>`;
                                }

                                if (r.warnings && r.warnings.length) {
                                    html += '<p style="color:var(--warning)"><strong>Warnings:</strong></p><ul>';
                                    r.warnings.forEach(w => html += `<li style="color:var(--warning);font-size:12px">${w}</li>`);
                                    html += '</ul>';
                                }
                                if (r.cached) html += '<p style="color:var(--text-muted)">â„¹ï¸ Using cached analysis from a previous fetch of this URL.</p>';

                                $('#urlResultContent').innerHTML = html;
                                $('#urlResults').style.display = 'block';
                                toast('URL analysis complete!', 'success');
                                if (typeof emitSparkles === 'function') emitSparkles($('#btnFetchAnalyze'));

                                // Auto-populate AI Notes tab
                                if (stem) {
                                    window._lastVideoStem = stem;
                                    if ($('#noteStem')) {
                                        $('#noteStem').value = stem;
                                        if ($('#notesStemHint')) $('#notesStemHint').style.display = 'block';
                                        if ($('#notesNoAnalysis')) $('#notesNoAnalysis').style.display = 'none';
                                    }
                                }

                                btn.disabled = false;
                                updateUrlBtn();
                            },
                            // onFail
                            (job) => {
                                $('#urlProgressLabel').textContent = 'Failed';
                                $('#urlProgressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                toast('Error: ' + (job.error || 'Unknown error'), 'error');
                                btn.disabled = false;
                                updateUrlBtn();
                            }
                        );

                    } catch (err) {
                        $('#urlProgressLabel').textContent = 'Failed';
                        $('#urlProgressBar').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        toast('Network error: ' + err.message, 'error');
                        btn.disabled = false;
                        updateUrlBtn();
                    }
                });
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // AGENT CHAT (Tab 5)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initChat() {
                const msgArea = $('#chatMessages');
                const input = $('#chatInput');
                const sendBtn = $('#btnChatSend');
                if (!msgArea || !input || !sendBtn) return;

                function getStem() {
                    return window._lastVideoStem || ($('#noteStem') && $('#noteStem').value.trim()) || 'video';
                }

                function addMsg(role, html) {
                    const empty = $('#chatEmpty');
                    if (empty) empty.remove();
                    const div = document.createElement('div');
                    div.className = `chat-msg ${role}`;
                    const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                    div.innerHTML = `<div class="chat-avatar">${avatar}</div><div class="chat-bubble">${html}</div>`;
                    msgArea.appendChild(div);
                    msgArea.scrollTop = msgArea.scrollHeight;
                    return div;
                }

                function addTyping() {
                    const div = addMsg('bot', '<div class="chat-typing"><span></span><span></span><span></span></div>');
                    div.id = 'chatTyping';
                    return div;
                }

                async function sendQuestion() {
                    const q = input.value.trim();
                    if (!q) return;
                    input.value = '';
                    addMsg('user', q);

                    const stem = getStem();
                    const typing = addTyping();
                    sendBtn.disabled = true;

                    try {
                        const resp = await fetch('/ask', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ video_stem: stem, question: q })
                        });
                        const data = await resp.json();
                        if (typing) typing.remove();

                        if (data.detail) {
                            addMsg('bot', `<span style="color:#ef4444">âŒ ${data.detail}</span>`);
                            sendBtn.disabled = false;
                            return;
                        }

                        // FastReply
                        const fr = data.fast_reply || {};
                        let fastHtml = `<div class="chat-badge fast">âš¡ FastReply Â· ${fr.latency_ms || '?'}ms</div><br>`;
                        fastHtml += fr.reply || 'No instant answer available.';
                        if (fr.provenance && fr.provenance.length) {
                            fastHtml += '<div class="chat-provenance">';
                            fr.provenance.forEach(p => {
                                fastHtml += `<span class="chat-provenance-tag">${p}</span>`;
                            });
                            fastHtml += '</div>';
                        }
                        const fastMsg = addMsg('bot', fastHtml);

                        // Poll for PolishReply
                        if (data.job_id) {
                            const pollId = setInterval(async () => {
                                try {
                                    const jr = await fetch(`/jobs/${data.job_id}`);
                                    const job = await jr.json();
                                    if (job.status === 'done' && job.result) {
                                        clearInterval(pollId);
                                        const pr = job.result;
                                        let polishHtml = `<div class="chat-badge polish">ğŸ§  PolishReply Â· ${pr.source || 'LLM'}</div><br>`;
                                        polishHtml += pr.reply || pr.text || JSON.stringify(pr);
                                        if (pr.provenance && pr.provenance.length) {
                                            polishHtml += '<div class="chat-provenance">';
                                            pr.provenance.forEach(p => {
                                                polishHtml += `<span class="chat-provenance-tag">${p}</span>`;
                                            });
                                            polishHtml += '</div>';
                                        }
                                        addMsg('bot', polishHtml);
                                    } else if (job.status === 'failed') {
                                        clearInterval(pollId);
                                        addMsg('bot', `<span style="color:var(--warning)">âš  Polish reply failed: ${job.error || 'unknown'}</span>`);
                                    }
                                } catch (e) { /* retry */ }
                            }, 2000);
                            setTimeout(() => clearInterval(pollId), 60000);
                        }
                    } catch (err) {
                        if (typing) typing.remove();
                        addMsg('bot', `<span style="color:#ef4444">âŒ Error: ${err.message}</span>`);
                    }
                    sendBtn.disabled = false;
                }

                sendBtn.addEventListener('click', sendQuestion);
                input.addEventListener('keydown', e => { if (e.key === 'Enter') sendQuestion(); });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // QUIZ GENERATION (Tab 6)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initQuiz() {
                const genBtn = $('#btnQuizGen');
                if (!genBtn) return;
                let quizScore = 0, quizTotal = 0;

                function getStem() {
                    return window._lastVideoStem || ($('#noteStem') && $('#noteStem').value.trim()) || 'video';
                }

                function updateScore() {
                    const el = $('#quizScoreText');
                    if (el) el.textContent = `Score: ${quizScore} / ${quizTotal}`;
                }

                genBtn.addEventListener('click', async () => {
                    const stem = getStem();
                    const count = parseInt($('#quizCount').value) || 5;
                    genBtn.disabled = true;
                    genBtn.innerHTML = '<span class="spinner"></span> Generatingâ€¦';
                    quizScore = 0;
                    quizTotal = 0;

                    try {
                        const resp = await fetch('/generate_quiz', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ video_stem: stem, count: count })
                        });
                        const data = await resp.json();

                        if (data.detail) throw new Error(data.detail);
                        if (data.error) throw new Error(data.error);

                        // Backend returns {mcq:[...], short:[...]} â€” merge into unified questions array
                        const mcqs = (data.mcq || []).map(q => ({
                            ...q,
                            type: 'mcq',
                            // Backend uses answer: 'A'/'B'/'C'/'D' letter â€” convert to index
                            correct_index: q.answer && q.answer.length === 1
                                ? 'ABCD'.indexOf(q.answer.toUpperCase())
                                : (q.answer_index ?? q.correct_index ?? -1)
                        }));
                        const shorts = (data.short || []).map(q => ({ ...q, type: 'short' }));
                        const questions = [...mcqs, ...shorts];
                        const cards = $('#quizCards');
                        cards.innerHTML = '';
                        $('#quizResults').style.display = 'block';
                        updateScore();

                        // Provider badge
                        const pb = $('#quizProviderBadge');
                        if (pb && data.llm_provider) pb.textContent = `LLM: ${data.llm_provider}`;

                        questions.forEach((q, i) => {
                            const card = document.createElement('div');
                            card.className = 'quiz-card';

                            const isMCQ = q.type === 'mcq' || (q.options && q.options.length > 0);
                            let html = `<div class="quiz-q-num">${isMCQ ? 'ğŸ“ MCQ' : 'âœï¸ Short Answer'} â€” Question ${i + 1}</div>`;
                            html += `<div class="quiz-q-text">${q.question}</div>`;

                            if (isMCQ && q.options) {
                                q.options.forEach((opt, j) => {
                                    const letter = String.fromCharCode(65 + j);
                                    html += `<button class="quiz-option" data-idx="${j}" data-correct="${q.correct_index ?? q.answer_index ?? -1}">${letter}. ${opt}</button>`;
                                });
                                html += `<div class="quiz-explanation" id="quizExpl${i}">${q.explanation || 'No explanation provided.'}</div>`;
                            } else {
                                // Short answer
                                html += `<div class="quiz-sa-answer">`;
                                html += `<button class="quiz-sa-reveal" data-target="quizSA${i}">ğŸ‘ Reveal Answer</button>`;
                                html += `<div class="quiz-sa-text" id="quizSA${i}">${q.answer || q.correct_answer || 'No answer available.'}</div>`;
                                html += `</div>`;
                            }

                            card.innerHTML = html;
                            cards.appendChild(card);

                            // MCQ click handlers
                            if (isMCQ) {
                                card.querySelectorAll('.quiz-option').forEach(btn => {
                                    btn.addEventListener('click', () => {
                                        if (btn.classList.contains('chosen')) return;
                                        const correct = parseInt(btn.dataset.correct);
                                        const chosen = parseInt(btn.dataset.idx);
                                        quizTotal++;

                                        card.querySelectorAll('.quiz-option').forEach(b => b.classList.add('chosen'));

                                        if (chosen === correct) {
                                            btn.classList.add('correct');
                                            btn.innerHTML = 'âœ… ' + btn.textContent;
                                            quizScore++;
                                        } else {
                                            btn.classList.add('wrong');
                                            btn.innerHTML = 'âŒ ' + btn.textContent;
                                            // Highlight correct one
                                            card.querySelectorAll('.quiz-option').forEach(b => {
                                                if (parseInt(b.dataset.idx) === correct) {
                                                    b.classList.add('correct');
                                                    b.innerHTML = 'âœ… ' + b.textContent;
                                                }
                                            });
                                        }
                                        updateScore();
                                        const expl = card.querySelector('.quiz-explanation');
                                        if (expl) expl.classList.add('shown');
                                    });
                                });
                            }

                            // SA reveal handler
                            const revealBtn = card.querySelector('.quiz-sa-reveal');
                            if (revealBtn) {
                                revealBtn.addEventListener('click', () => {
                                    const target = document.getElementById(revealBtn.dataset.target);
                                    if (target) target.style.display = target.style.display === 'block' ? 'none' : 'block';
                                });
                            }
                        });

                        toast(`Quiz generated! ${questions.length} questions`, 'success');
                    } catch (err) {
                        toast('Quiz error: ' + err.message, 'error');
                    }

                    genBtn.disabled = false;
                    genBtn.innerHTML = '<span>ğŸ²</span> Generate Quiz';
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // EXPORT / DOWNLOAD HELPERS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            function downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                toast(`Downloaded ${filename}`, 'success');
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // HEALTH STATUS INDICATOR
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            async function pingHealth() {
                const dot = $('#healthDotCircle');
                const lbl = $('#healthDotLabel');
                const wrap = $('#healthDot');
                try {
                    const r = await fetch('/health', { signal: AbortSignal.timeout(3000) });
                    const d = await r.json();
                    if (d.status === 'ok') {
                        dot.style.background = '#22c55e';
                        lbl.textContent = `Online Â· ${d.llm_provider || 'LLM'}`;
                        wrap.style.color = '#22c55e';
                        wrap.style.borderColor = 'rgba(34,197,94,0.3)';
                        wrap.title = `Uptime: ${d.uptime_seconds}s | Uploads: ${d.uploads_count} | Analyses: ${d.analyses_count} | ffmpeg: ${d.ffmpeg_available ? 'âœ“' : 'âœ—'}`;
                    } else { throw new Error('not ok'); }
                } catch {
                    dot.style.background = '#ef4444';
                    lbl.textContent = 'Server offline';
                    wrap.style.color = '#ef4444';
                    wrap.style.borderColor = 'rgba(239,68,68,0.3)';
                }
            }
            pingHealth();
            setInterval(pingHealth, 30000);

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // VIDEO STEM PROPAGATION â€” update chat & quiz when analysis completes
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function watchStemChanges() {
                const origSetter = Object.getOwnPropertyDescriptor(window, '_lastVideoStem');
                let _stemValue = window._lastVideoStem || '';

                function propagateStem(stem) {
                    // Chat panel
                    if ($('#chatStemLabel')) $('#chatStemLabel').textContent = stem;
                    if ($('#chatReadyHint')) $('#chatReadyHint').style.display = 'block';
                    if ($('#chatNoAnalysis')) $('#chatNoAnalysis').style.display = 'none';
                    // Quiz panel
                    if ($('#quizStemLabel')) $('#quizStemLabel').textContent = stem;
                    if ($('#quizReadyHint')) $('#quizReadyHint').style.display = 'block';
                    if ($('#quizNoAnalysis')) $('#quizNoAnalysis').style.display = 'none';
                }

                // Intercept writes to window._lastVideoStem
                Object.defineProperty(window, '_lastVideoStem', {
                    get() { return _stemValue; },
                    set(v) {
                        _stemValue = v;
                        if (v) propagateStem(v);
                    },
                    configurable: true
                });

                // Check if already set
                if (_stemValue) propagateStem(_stemValue);
            })();


            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // TAB 13: ECOWATCH RANGER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initEcoWatch() {
                let stream = null, timer = null, running = false;
                let ecoAlerts = [];

                function capFrame(videoEl) {
                    const c = document.createElement('canvas');
                    c.width = videoEl.videoWidth || 640;
                    c.height = videoEl.videoHeight || 480;
                    c.getContext('2d').drawImage(videoEl, 0, 0);
                    return c.toDataURL('image/jpeg', 0.75).split(',')[1];
                }

                async function startRanger() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        const vid = document.getElementById('ecoVideo');
                        vid.srcObject = stream;
                        document.getElementById('btnEcoStart').disabled = true;
                        document.getElementById('btnEcoStop').disabled = false;
                        document.getElementById('ecoStatus').textContent = 'ğŸŸ¢ Ranger active â€” scanning for threatsâ€¦';
                        running = true;
                        timer = setInterval(analyzeEcoFrame, 2500);
                    } catch (e) { toast('Camera error: ' + e.message, 'error'); }
                }

                async function analyzeEcoFrame() {
                    if (!running) return;
                    const vid = document.getElementById('ecoVideo');
                    if (!vid.videoWidth) return;
                    const b64 = capFrame(vid);
                    const loc = document.getElementById('ecoLocation').value || 'Sector-Unknown';
                    try {
                        const r = await fetch('/eco_analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64: b64, location: loc })
                        });
                        const d = await r.json();
                        if (!d.ok) return;

                        // Update threat display
                        const threatEl = document.getElementById('ecoThreatInfo');
                        threatEl.textContent = d.threat_label;
                        threatEl.style.color = d.threat_color;
                        document.getElementById('ecoThreatAction').textContent = d.threat_action;

                        // Badge on video
                        const badge = document.getElementById('ecoThreatBadge');
                        if (d.threat_category !== 'clear') {
                            badge.textContent = d.threat_label;
                            badge.style.background = d.threat_color + 'dd';
                            badge.style.color = ['fire', 'vehicle'].includes(d.threat_category) ? '#fff' : '#000';
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }

                        document.getElementById('ecoTotalThreats').textContent = d.total_threats_today || 0;
                        document.getElementById('ecoLatency').textContent = d.latency_ms;

                        // Add to alert log
                        if (d.threat_category !== 'clear') {
                            const ts = new Date().toLocaleTimeString();
                            ecoAlerts.unshift(`<span style="color:${d.threat_color}">[${ts}] ${d.threat_label}</span> @ ${loc}`);
                            ecoAlerts = ecoAlerts.slice(0, 30);
                            document.getElementById('ecoAlertLog').innerHTML = ecoAlerts.join('<br>');
                        }

                        // Wildlife count via /eco_wildlife
                        fetch('/eco_wildlife?limit=200').then(r => r.json()).then(d => {
                            document.getElementById('ecoWildlife').textContent = (d.sightings || []).length;
                        }).catch(() => { });
                    } catch (e) { console.warn('EcoWatch error', e); }
                }

                function stopRanger() {
                    running = false;
                    clearInterval(timer);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    document.getElementById('btnEcoStart').disabled = false;
                    document.getElementById('btnEcoStop').disabled = true;
                    document.getElementById('ecoStatus').textContent = 'â¹ Stopped.';
                    document.getElementById('ecoThreatBadge').style.display = 'none';
                }

                document.getElementById('btnEcoStart').addEventListener('click', startRanger);
                document.getElementById('btnEcoStop').addEventListener('click', stopRanger);
                document.getElementById('btnEcoReset').addEventListener('click', () => {
                    fetch('/eco_reset', { method: 'POST' });
                    ecoAlerts = [];
                    document.getElementById('ecoAlertLog').innerHTML = '<em style="color:var(--text-muted)">Log cleared.</em>';
                    document.getElementById('ecoTotalThreats').textContent = '0';
                    document.getElementById('ecoWildlife').textContent = '0';
                    document.getElementById('ecoThreatInfo').textContent = 'âœ… AREA CLEAR';
                    document.getElementById('ecoThreatInfo').style.color = '#22c55e';
                    document.getElementById('ecoThreatAction').textContent = 'Normal monitoring';
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // TAB 14: BLINDSPOT GUARDIAN
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initBlindSpot() {
                let stream = null, timer = null, running = false;
                let hazardLog = [];
                let synth = window.speechSynthesis;
                let lastSpoken = '';

                function capFrame(v) {
                    const c = document.createElement('canvas');
                    c.width = v.videoWidth || 640; c.height = v.videoHeight || 480;
                    c.getContext('2d').drawImage(v, 0, 0);
                    return c.toDataURL('image/jpeg', 0.8).split(',')[1];
                }

                function speak(msg) {
                    if (!synth || msg === lastSpoken) return;
                    lastSpoken = msg;
                    synth.cancel();
                    const u = new SpeechSynthesisUtterance(msg.replace(/[âš ï¸ğŸš—ğŸš›ğŸšŒğŸš¦ğŸ›‘ğŸ•ğŸˆğŸš’ğŸª‘ğŸŒ¿âœ…]/g, ''));
                    u.rate = 1.1; u.pitch = 1;
                    synth.speak(u);
                    setTimeout(() => { lastSpoken = ''; }, 4000);
                }

                async function startGuardian() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        const v = document.getElementById('blindVideo');
                        v.srcObject = stream;
                        document.getElementById('btnBlindStart').disabled = true;
                        document.getElementById('btnBlindStop').disabled = false;
                        document.getElementById('blindStatus').textContent = 'ğŸŸ¢ Guardian active â€” monitoring roadâ€¦';
                        running = true;
                        timer = setInterval(analyzeFrame, 1500);
                    } catch (e) { toast('Camera error: ' + e.message, 'error'); }
                }

                async function analyzeFrame() {
                    if (!running) return;
                    const v = document.getElementById('blindVideo');
                    if (!v.videoWidth) return;
                    const b64 = capFrame(v);
                    try {
                        const r = await fetch('/blindspot_analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64: b64 })
                        });
                        const d = await r.json();
                        if (!d.ok) return;

                        // Update road status
                        const alertEl = document.getElementById('blindTopAlert');
                        alertEl.textContent = d.top_alert;
                        alertEl.style.color = d.top_color;
                        document.getElementById('blindTip').textContent = d.driving_tip || '';
                        document.getElementById('blindTotal').textContent = d.total_hazards_session || 0;
                        document.getElementById('blindTrip').textContent = (d.session_duration_s || 0) + 's';
                        document.getElementById('blindLatency').textContent = d.latency_ms;

                        // Badge overlay
                        const badge = document.getElementById('blindAlertBadge');
                        if (d.top_level !== 'clear') {
                            badge.textContent = d.top_alert;
                            badge.style.background = d.top_color + 'ee';
                            badge.style.color = '#fff';
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }

                        // Voice alert for high priority
                        if (['danger', 'warning'].includes(d.top_level) && document.getElementById('blindVoice').checked) {
                            speak(d.top_alert + '. ' + d.driving_tip);
                        }

                        // Log
                        if (d.hazard_count > 0) {
                            const ts = new Date().toLocaleTimeString();
                            hazardLog.unshift(`<span style="color:${d.top_color}">[${ts}] ${d.top_alert}</span>`);
                            hazardLog = hazardLog.slice(0, 30);
                            document.getElementById('blindHazardLog').innerHTML = hazardLog.join('<br>');
                        }
                    } catch (e) { console.warn('BlindSpot error', e); }
                }

                function stopGuardian() {
                    running = false;
                    clearInterval(timer);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    document.getElementById('btnBlindStart').disabled = false;
                    document.getElementById('btnBlindStop').disabled = true;
                    document.getElementById('blindStatus').textContent = 'â¹ Stopped.';
                    document.getElementById('blindAlertBadge').style.display = 'none';
                    if (synth) synth.cancel();
                }

                document.getElementById('btnBlindStart').addEventListener('click', startGuardian);
                document.getElementById('btnBlindStop').addEventListener('click', stopGuardian);
                document.getElementById('btnBlindReset').addEventListener('click', () => {
                    fetch('/blindspot_reset', { method: 'POST' });
                    hazardLog = [];
                    document.getElementById('blindHazardLog').innerHTML = '<em style="color:var(--text-muted)">Hazard log cleared.</em>';
                    document.getElementById('blindTotal').textContent = '0';
                    document.getElementById('blindTrip').textContent = '0s';
                    document.getElementById('blindTopAlert').textContent = 'âœ… ROAD CLEAR';
                    document.getElementById('blindTopAlert').style.color = '#22c55e';
                    document.getElementById('blindTip').textContent = 'New trip started.';
                    lastSpoken = '';
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // TAB 15: MEETING ASSISTANT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initMeeting() {
                let stream = null, frameTimer = null, durationTimer = null, running = false;
                const SESSION = 'default';
                let startTs = null;

                function capFrame(v) {
                    const c = document.createElement('canvas');
                    c.width = v.videoWidth || 640; c.height = v.videoHeight || 480;
                    c.getContext('2d').drawImage(v, 0, 0);
                    return c.toDataURL('image/jpeg', 0.6).split(',')[1];
                }

                function appendTranscript(speaker, text, isAction, isDecision) {
                    const el = document.getElementById('meetingTranscript');
                    const color = isAction ? '#f59e0b' : isDecision ? '#22c55e' : 'var(--text-secondary)';
                    const tag = isAction ? ' ğŸ“Œ' : isDecision ? ' âœ…' : '';
                    const line = `<div style="margin-bottom:4px"><span style="color:#3b82f6;font-weight:600">${speaker}:</span> <span style="color:${color}">${text}${tag}</span></div>`;
                    el.innerHTML = el.innerHTML.replace('<em style="color:var(--text-muted)">Transcript will appear hereâ€¦</em>', '');
                    el.insertAdjacentHTML('beforeend', line);
                    el.scrollTop = el.scrollHeight;
                }

                async function startMeeting() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        document.getElementById('meetingVideo').srcObject = stream;
                        document.getElementById('btnMeetingStart').disabled = true;
                        document.getElementById('btnMeetingStop').disabled = false;
                        document.getElementById('btnMeetingSummarize').disabled = false;
                        running = true;
                        startTs = Date.now();
                        // Analyze frames every 3s for participant count
                        frameTimer = setInterval(async () => {
                            if (!running) return;
                            const v = document.getElementById('meetingVideo');
                            if (!v.videoWidth) return;
                            const b64 = capFrame(v);
                            try {
                                const r = await fetch('/meeting_frame', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ frame_b64: b64, session_id: SESSION })
                                });
                                const d = await r.json();
                                if (d.ok) document.getElementById('meetingParticipants').textContent = d.participants_visible;
                            } catch (e) { }
                        }, 3000);
                        // Duration counter
                        durationTimer = setInterval(() => {
                            const mins = Math.floor((Date.now() - startTs) / 60000);
                            document.getElementById('meetingDuration').textContent = mins + 'm';
                        }, 30000);
                        toast('Meeting started! Add transcript segments below.', 'success');
                    } catch (e) { toast('Camera error: ' + e.message, 'error'); }
                }

                function stopMeeting() {
                    running = false;
                    clearInterval(frameTimer); clearInterval(durationTimer);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    document.getElementById('btnMeetingStart').disabled = false;
                    document.getElementById('btnMeetingStop').disabled = true;
                    toast('Meeting ended.', 'success');
                }

                document.getElementById('btnMeetingStart').addEventListener('click', startMeeting);
                document.getElementById('btnMeetingStop').addEventListener('click', stopMeeting);

                // Add transcript segment
                document.getElementById('btnMeetingAdd').addEventListener('click', async () => {
                    const text = document.getElementById('meetingText').value.trim();
                    const speaker = document.getElementById('meetingSpeaker').value.trim() || 'Speaker';
                    if (!text) return;
                    try {
                        const r = await fetch('/meeting_transcript_add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text, speaker, session_id: SESSION })
                        });
                        const d = await r.json();
                        appendTranscript(speaker, text, d.is_action, d.is_decision);
                        document.getElementById('meetingText').value = '';
                        document.getElementById('meetingActions').textContent = d.action_items_count;
                        document.getElementById('meetingDecisions').textContent = d.decisions_count;
                    } catch (e) { toast('Failed to add transcript', 'error'); }
                });

                // Enter key for transcript
                document.getElementById('meetingText').addEventListener('keypress', e => {
                    if (e.key === 'Enter') document.getElementById('btnMeetingAdd').click();
                });

                // Summarize
                document.getElementById('btnMeetingSummarize').addEventListener('click', async () => {
                    const el = document.getElementById('meetingSummary');
                    el.textContent = 'â³ Generating summaryâ€¦';
                    try {
                        const r = await fetch('/meeting_summarize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: SESSION })
                        });
                        const d = await r.json();
                        if (d.ok) {
                            el.textContent = d.summary;
                            toast('Meeting summary ready!', 'success');
                        } else { el.textContent = 'Summary failed: ' + (d.error || 'Unknown'); }
                    } catch (e) { el.textContent = 'Error generating summary.'; }
                });

                // Clear
                document.getElementById('btnMeetingClear').addEventListener('click', () => {
                    fetch('/meeting_clear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: SESSION }) });
                    document.getElementById('meetingTranscript').innerHTML = '<em style="color:var(--text-muted)">Transcript will appear hereâ€¦</em>';
                    document.getElementById('meetingSummary').innerHTML = '<em style="color:var(--text-muted)">Click "Summarize" to generate a meeting summaryâ€¦</em>';
                    document.getElementById('meetingActions').textContent = '0';
                    document.getElementById('meetingDecisions').textContent = '0';
                    document.getElementById('meetingDuration').textContent = '0m';
                    document.getElementById('meetingParticipants').textContent = '0';
                });
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // TAB 16: ACCESSIBILITY AGENT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initAccessibility() {
                let stream = null, timer = null, running = false;
                let currentMode = 'scene';
                let synth = window.speechSynthesis;
                let captionHistory = [];

                function capFrame(v) {
                    const c = document.createElement('canvas');
                    c.width = v.videoWidth || 640; c.height = v.videoHeight || 480;
                    c.getContext('2d').drawImage(v, 0, 0);
                    return c.toDataURL('image/jpeg', 0.7).split(',')[1];
                }

                function speak(text) {
                    if (!synth || !document.getElementById('accessTts').checked) return;
                    synth.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.rate = 0.95; u.pitch = 1;
                    synth.speak(u);
                }

                function setMode(mode) {
                    currentMode = mode;
                    document.getElementById('accessModeBadge').textContent = mode.toUpperCase();
                    document.querySelectorAll('.access-mode-btn').forEach(b => {
                        b.style.borderColor = b.dataset.mode === mode ? '#f43f5e' : '';
                        b.style.color = b.dataset.mode === mode ? '#f43f5e' : '';
                    });
                }

                async function startAccess() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        const v = document.getElementById('accessVideo');
                        v.srcObject = stream;
                        document.getElementById('btnAccessStart').disabled = true;
                        document.getElementById('btnAccessStop').disabled = false;
                        document.getElementById('btnAccessDescribe').disabled = false;
                        document.getElementById('accessStatus').textContent = 'ğŸŸ¢ Accessibility mode activeâ€¦';
                        running = true;
                        // Auto-describe every 5 seconds
                        timer = setInterval(describeNow, 5000);
                        describeNow();
                    } catch (e) { toast('Camera error: ' + e.message, 'error'); }
                }

                async function describeNow(force = false) {
                    if (!running && !force) return;
                    const v = document.getElementById('accessVideo');
                    if (!v || !v.videoWidth) return;
                    const b64 = capFrame(v);
                    try {
                        const r = await fetch('/accessibility_describe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64: b64, mode: currentMode, force_refresh: !!force })
                        });
                        const d = await r.json();
                        if (!d.ok) return;

                        // Update caption
                        document.getElementById('accessCaption').textContent = d.description;
                        document.getElementById('accessProvider').textContent = d.provider || 'â€”';
                        document.getElementById('accessLatency').textContent = d.latency_ms;

                        // Spatial context
                        const objs = (d.spatial_context || {}).objects || [];
                        document.getElementById('accessObjects').innerHTML = objs.length
                            ? objs.map(o => `<div>ğŸ“ ${o}</div>`).join('')
                            : '<em style="color:var(--text-muted)">No nearby objects detected.</em>';

                        // Read aloud (not if cached)
                        if (!d.cached) {
                            speak(d.description);
                        }

                        // History
                        if (!d.cached) {
                            const ts = new Date().toLocaleTimeString();
                            captionHistory.unshift(`[${ts}] <em>${currentMode.toUpperCase()}</em>: ${d.description}`);
                            captionHistory = captionHistory.slice(0, 20);
                            document.getElementById('accessHistory').innerHTML = captionHistory.join('<hr style="opacity:0.15;margin:4px 0">');
                        }
                    } catch (e) { console.warn('Accessibility error', e); }
                }

                function stopAccess() {
                    running = false;
                    clearInterval(timer);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    document.getElementById('btnAccessStart').disabled = false;
                    document.getElementById('btnAccessStop').disabled = true;
                    document.getElementById('btnAccessDescribe').disabled = true;
                    document.getElementById('accessStatus').textContent = 'â¹ Stopped.';
                    if (synth) synth.cancel();
                }

                document.getElementById('btnAccessStart').addEventListener('click', startAccess);
                document.getElementById('btnAccessStop').addEventListener('click', stopAccess);
                document.getElementById('btnAccessDescribe').addEventListener('click', () => describeNow(true));

                // Mode buttons
                document.querySelectorAll('.access-mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => setMode(btn.dataset.mode));
                });

                // Initialize mode highlight
                setMode('scene');
            })();

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COSMIC STARFIELD BACKGROUND

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function initCosmic() {
                const canvas = document.getElementById('cosmicCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let W, H;
                let mouseX = 0, mouseY = 0;

                function resize() {
                    W = canvas.width = window.innerWidth;
                    H = canvas.height = window.innerHeight;
                }
                window.addEventListener('resize', resize);
                resize();

                // Track mouse for subtle parallax
                document.addEventListener('mousemove', e => {
                    mouseX = (e.clientX / W - 0.5) * 2;
                    mouseY = (e.clientY / H - 0.5) * 2;
                });

                // Star data
                const STAR_COUNT = 180;
                const stars = [];
                for (let i = 0; i < STAR_COUNT; i++) {
                    stars.push({
                        x: Math.random() * W,
                        y: Math.random() * H,
                        r: Math.random() * 1.5 + 0.3,
                        speed: Math.random() * 0.15 + 0.02,
                        drift: (Math.random() - 0.5) * 0.08,
                        twinkle: Math.random() * Math.PI * 2,
                        twinkleSpeed: Math.random() * 0.02 + 0.005,
                        depth: Math.random(),  // 0=far, 1=near (parallax factor)
                        hue: Math.random() > 0.85 ? (Math.random() * 60 + 200) : 0, // some blue/purple tinted
                    });
                }

                // Nebula data (a few large soft glows)
                const nebulae = [
                    { x: 0.2, y: 0.3, rx: 300, ry: 200, hue: 260, sat: 70, alpha: 0.04 },
                    { x: 0.7, y: 0.6, rx: 250, ry: 350, hue: 230, sat: 60, alpha: 0.03 },
                    { x: 0.5, y: 0.8, rx: 400, ry: 200, hue: 280, sat: 50, alpha: 0.025 },
                ];

                let time = 0;

                function draw() {
                    time++;
                    ctx.clearRect(0, 0, W, H);

                    // Deep space gradient background
                    const grad = ctx.createRadialGradient(W * 0.5, H * 0.5, 0, W * 0.5, H * 0.5, Math.max(W, H) * 0.7);
                    grad.addColorStop(0, '#0d0d1a');
                    grad.addColorStop(0.5, '#080812');
                    grad.addColorStop(1, '#030308');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, W, H);

                    // Draw nebulae (soft radial glows)
                    nebulae.forEach(n => {
                        const nx = n.x * W + mouseX * 8;
                        const ny = n.y * H + mouseY * 8;
                        const ng = ctx.createRadialGradient(nx, ny, 0, nx, ny, n.rx);
                        const c = `hsla(${n.hue}, ${n.sat}%, 50%,`;
                        ng.addColorStop(0, c + (n.alpha + 0.01) + ')');
                        ng.addColorStop(0.4, c + n.alpha + ')');
                        ng.addColorStop(1, c + '0)');
                        ctx.fillStyle = ng;
                        ctx.fillRect(0, 0, W, H);
                    });

                    // Draw and update stars
                    stars.forEach(s => {
                        // Move
                        s.y += s.speed;
                        s.x += s.drift;

                        // Parallax from mouse
                        const px = s.x + mouseX * s.depth * 12;
                        const py = s.y + mouseY * s.depth * 12;

                        // Wrap around
                        if (s.y > H + 5) { s.y = -5; s.x = Math.random() * W; }
                        if (s.x > W + 5) s.x = -5;
                        if (s.x < -5) s.x = W + 5;

                        // Twinkle
                        s.twinkle += s.twinkleSpeed;
                        const alpha = 0.4 + 0.6 * (0.5 + 0.5 * Math.sin(s.twinkle));

                        // Draw star
                        ctx.beginPath();
                        ctx.arc(px, py, s.r, 0, Math.PI * 2);
                        if (s.hue > 0) {
                            ctx.fillStyle = `hsla(${s.hue}, 80%, 80%, ${alpha})`;
                        } else {
                            ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                        }
                        ctx.fill();

                        // Glow for larger stars
                        if (s.r > 1.2) {
                            ctx.beginPath();
                            ctx.arc(px, py, s.r * 3, 0, Math.PI * 2);
                            const glowColor = s.hue > 0
                                ? `hsla(${s.hue}, 70%, 70%, ${alpha * 0.1})`
                                : `rgba(200, 200, 255, ${alpha * 0.08})`;
                            ctx.fillStyle = glowColor;
                            ctx.fill();
                        }
                    });

                    requestAnimationFrame(draw);
                }
                draw();
            })();
        </script>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             GLOBAL TTS HELPER + VOICE INPUT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            /* â”€â”€ Global TTS helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            window.VA_SPEAK = function (text, opts = {}) {
                if (!window.speechSynthesis || !text) return;
                if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
                const utt = new SpeechSynthesisUtterance(text);
                utt.rate = opts.rate || 1.0;
                utt.pitch = opts.pitch || 1.0;
                utt.volume = opts.volume || 0.9;
                if (opts.voice) {
                    const voices = speechSynthesis.getVoices();
                    const v = voices.find(x => x.name.includes(opts.voice));
                    if (v) utt.voice = v;
                }
                window.speechSynthesis.speak(utt);
            };

            /* â”€â”€ Live Provider Badge Heartbeat (updates every 15 s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            (function providerBadgeLoop() {
                const badge = document.getElementById('providerBadge') || document.querySelector('[id*="provider"]');
                async function refresh() {
                    try {
                        const r = await fetch('/health');
                        if (!r.ok) return;
                        const d = await r.json();
                        const pName = d.llm_provider || d.provider || 'Auto';
                        if (badge) {
                            badge.textContent = pName;
                            badge.title = 'Active LLM: ' + pName;
                        }
                        // update dashboard badge if exists
                        const dashBadge = document.getElementById('dashProvider');
                        if (dashBadge) dashBadge.textContent = pName;
                    } catch (_) { }
                }
                refresh();
                setInterval(refresh, 15000);
            })();

            /* â”€â”€ Voice Mic Button for Agent Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            (function voiceMicInit() {
                // Find the agent chat input and inject a mic button next to it
                const chatInput = document.getElementById('agentChatInput') ||
                    document.querySelector('input[placeholder*="message"]') ||
                    document.querySelector('textarea[placeholder*="message"]');
                if (!chatInput || !('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                const micBtn = document.createElement('button');
                micBtn.id = 'voiceInputBtn';
                micBtn.title = 'Voice Input (hold to speak)';
                micBtn.style.cssText = 'background:rgba(99,102,241,0.2);border:1px solid rgba(99,102,241,0.4);border-radius:8px;padding:8px 12px;color:#a5b4fc;cursor:pointer;font-size:18px;line-height:1;transition:all 0.2s;margin-left:6px';
                micBtn.textContent = 'ğŸ¤';
                chatInput.parentNode.insertBefore(micBtn, chatInput.nextSibling);

                let rec = null;
                micBtn.addEventListener('click', () => {
                    if (rec) { rec.stop(); return; }
                    rec = new SR();
                    rec.lang = 'en-US';
                    rec.continuous = false;
                    rec.interimResults = false;
                    micBtn.style.background = 'rgba(239,68,68,0.3)';
                    micBtn.style.borderColor = 'rgba(239,68,68,0.6)';
                    micBtn.textContent = 'ğŸ”´';
                    rec.onresult = e => {
                        chatInput.value = e.results[0][0].transcript;
                        chatInput.dispatchEvent(new Event('input'));
                    };
                    rec.onend = () => {
                        rec = null;
                        micBtn.style.background = 'rgba(99,102,241,0.2)';
                        micBtn.style.borderColor = 'rgba(99,102,241,0.4)';
                        micBtn.textContent = 'ğŸ¤';
                    };
                    rec.start();
                });
            })();
        </script>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB 13: ECOWATCH RANGER JAVASCRIPT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            (function EcoWatchModule() {
                let stream = null, intervalId = null, isRunning = false;
                const video = document.getElementById('ecoVideo');
                const btnStart = document.getElementById('btnEcoStart');
                const btnStop = document.getElementById('btnEcoStop');
                const btnReset = document.getElementById('btnEcoReset');
                const status = document.getElementById('ecoStatus');
                const threatInfo = document.getElementById('ecoThreatInfo');
                const threatAction = document.getElementById('ecoThreatAction');
                const threatBadge = document.getElementById('ecoThreatBadge');
                const alertLog = document.getElementById('ecoAlertLog');
                const totalThreats = document.getElementById('ecoTotalThreats');
                const wildlifeEl = document.getElementById('ecoWildlife');
                const latencyEl = document.getElementById('ecoLatency');
                const locationInput = document.getElementById('ecoLocation');

                if (!btnStart) return; // Panel not in DOM yet

                function captureFrame() {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    return canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                }

                async function analyzeFrame() {
                    if (!isRunning || !video.srcObject) return;
                    const t0 = Date.now();
                    const frame_b64 = captureFrame();
                    const location = locationInput ? locationInput.value || 'Unknown' : 'Unknown';
                    try {
                        const r = await fetch('/eco_analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64, location })
                        });
                        const d = await r.json();
                        const latency = Date.now() - t0;
                        if (latencyEl) latencyEl.textContent = latency;

                        // Threat level
                        const threat = d.threat_level || 'CLEAR';
                        const detected = d.detected_threats || [];
                        const tColor = threat === 'CRITICAL' ? '#ef4444' :
                            threat === 'HIGH' ? '#f97316' :
                                threat === 'MEDIUM' ? '#eab308' : '#22c55e';
                        if (threatInfo) {
                            threatInfo.style.color = tColor;
                            threatInfo.textContent = detected.length
                                ? `âš ï¸ ${detected.map(t => t.type || t).join(', ')}`
                                : 'âœ… AREA CLEAR';
                        }
                        if (threatAction) threatAction.textContent = d.recommended_action || 'Normal monitoring';
                        if (threatBadge && threat !== 'CLEAR') {
                            threatBadge.style.display = 'block';
                            threatBadge.style.background = tColor;
                            threatBadge.textContent = 'âš ï¸ ' + threat;
                        } else if (threatBadge) {
                            threatBadge.style.display = 'none';
                        }

                        // Stats
                        if (d.stats) {
                            if (totalThreats) totalThreats.textContent = d.stats.total_threats || 0;
                            if (wildlifeEl) wildlifeEl.textContent = d.stats.wildlife_sightings || 0;
                        }

                        // Alert log
                        if (detected.length && alertLog) {
                            const time = new Date().toLocaleTimeString();
                            const entry = document.createElement('div');
                            entry.style.cssText = 'padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);color:#fbbf24';
                            entry.textContent = `${time} â€” âš ï¸ ${detected.map(t => t.type || t).join(', ')} [${threat}]`;
                            alertLog.insertBefore(entry, alertLog.firstChild);
                            // Keep max 50 entries
                            while (alertLog.children.length > 50) alertLog.removeChild(alertLog.lastChild);
                            // TTS alert for HIGH/CRITICAL
                            if (threat === 'HIGH' || threat === 'CRITICAL') {
                                VA_SPEAK(`EcoWatch alert: ${detected[0].type || detected[0]} detected in ${location}`, { rate: 1.1 });
                            }
                        }
                    } catch (e) {
                        if (status) status.textContent = 'âš ï¸ API error: ' + e.message;
                    }
                }

                async function startRanger() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
                        video.srcObject = stream;
                        await video.play();
                        isRunning = true;
                        btnStart.disabled = true;
                        btnStop.disabled = false;
                        if (status) status.textContent = 'ğŸŸ¢ EcoWatch Ranger active â€” scanningâ€¦';
                        if (alertLog) alertLog.innerHTML = '';
                        intervalId = setInterval(analyzeFrame, 3000); // every 3s
                    } catch (e) {
                        if (status) status.textContent = 'âŒ Camera access denied: ' + e.message;
                    }
                }

                function stopRanger() {
                    isRunning = false;
                    clearInterval(intervalId);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    video.srcObject = null;
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                    if (status) status.textContent = 'â¹ EcoWatch stopped.';
                    if (threatBadge) threatBadge.style.display = 'none';
                }

                async function resetSession() {
                    stopRanger();
                    try { await fetch('/eco_reset', { method: 'POST' }); } catch (_) { }
                    if (totalThreats) totalThreats.textContent = '0';
                    if (wildlifeEl) wildlifeEl.textContent = '0';
                    if (alertLog) alertLog.innerHTML = '<em style="color:var(--text-muted)">Reset. Start ranger to begin monitoringâ€¦</em>';
                    if (threatInfo) threatInfo.textContent = 'âœ… AREA CLEAR';
                    if (threatInfo) threatInfo.style.color = '#22c55e';
                }

                btnStart.addEventListener('click', startRanger);
                btnStop.addEventListener('click', stopRanger);
                if (btnReset) btnReset.addEventListener('click', resetSession);
            })();
        </script>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB 14: BLINDSPOT GUARDIAN JAVASCRIPT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            (function BlindSpotModule() {
                let stream = null, intervalId = null, isRunning = false;
                // Use actual HTML IDs from panelBlindSpot
                const video = document.getElementById('blindVideo');
                const canvas = null; // drawn via offscreen canvas
                const btnStart = document.getElementById('btnBlindStart');
                const btnStop = document.getElementById('btnBlindStop');
                const btnReset = document.getElementById('btnBlindReset');
                const statusEl = document.getElementById('blindStatus');
                const alertEl = document.getElementById('blindTopAlert');
                const alertMsg = document.getElementById('blindTip');
                const hazardEl = null; // no dedicated hazard el in HTML
                const alertLog = document.getElementById('blindHazardLog');
                const distEl = null;
                const speedEl = null;
                const totalAl = document.getElementById('blindTotal');
                const latencyEl = document.getElementById('blindLatency');
                const alertBadge = document.getElementById('blindAlertBadge');
                const voiceToggle = document.getElementById('blindVoice');

                if (!btnStart) return;

                let voiceEnabled = true;
                if (voiceToggle) voiceToggle.addEventListener('change', () => { voiceEnabled = voiceToggle.checked; });

                const SEVERITY_COLOR = { CRITICAL: '#ef4444', HIGH: '#f97316', MEDIUM: '#eab308', LOW: '#22c55e', CLEAR: '#22c55e' };

                function captureFrame() {
                    if (!canvas || !video) return null;
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    return canvas.toDataURL('image/jpeg', 0.75).split(',')[1];
                }

                async function analyzeFrame() {
                    if (!isRunning) return;
                    const t0 = Date.now();
                    const frame_b64 = captureFrame();
                    if (!frame_b64) return;
                    try {
                        const r = await fetch('/blindspot_analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64 })
                        });
                        const d = await r.json();
                        if (latencyEl) latencyEl.textContent = Date.now() - t0;

                        const sev = d.alert_severity || 'CLEAR';
                        const color = SEVERITY_COLOR[sev] || '#22c55e';

                        if (alertEl) {
                            alertEl.textContent = sev;
                            alertEl.style.color = color;
                        }
                        if (alertMsg) alertMsg.textContent = d.alert_message || 'All clear.';

                        const hazards = d.detected_hazards || [];
                        if (hazardEl) hazardEl.textContent = hazards.length ? hazards.map(h => h.type || h).join(' Â· ') : 'â€”';
                        if (distEl && d.nearest_distance) distEl.textContent = d.nearest_distance;
                        if (speedEl && d.relative_speed) speedEl.textContent = d.relative_speed;
                        if (d.stats && totalAl) totalAl.textContent = d.stats.total_alerts || 0;

                        // Voice alert
                        if (voiceEnabled && d.voice_alert && (sev === 'HIGH' || sev === 'CRITICAL')) {
                            VA_SPEAK(d.voice_alert, { rate: 1.2, pitch: 0.9 });
                        }

                        // Log
                        if (hazards.length && alertLog) {
                            const entry = document.createElement('div');
                            entry.style.cssText = `padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);color:${color}`;
                            entry.textContent = `${new Date().toLocaleTimeString()} â€” ${sev}: ${hazards.map(h => h.type || h).join(', ')}`;
                            alertLog.insertBefore(entry, alertLog.firstChild);
                            while (alertLog.children.length > 60) alertLog.removeChild(alertLog.lastChild);
                        }

                        // Canvas overlay â€” draw hazard boxes
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            hazards.forEach(h => {
                                if (!h.bbox) return;
                                const [x1, y1, x2, y2] = h.bbox;
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 2;
                                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                                ctx.fillStyle = color;
                                ctx.font = 'bold 12px Inter,sans-serif';
                                ctx.fillText(`${h.type || ''} ${h.proximity_score ? Math.round(h.proximity_score * 100) + '%' : ''}`, x1 + 4, y1 + 14);
                            });
                        }
                    } catch (e) {
                        if (statusEl) statusEl.textContent = 'âš ï¸ Error: ' + e.message;
                    }
                }

                async function startGuardian() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
                        video.srcObject = stream;
                        await video.play();
                        isRunning = true;
                        btnStart.disabled = true;
                        btnStop.disabled = false;
                        if (statusEl) statusEl.textContent = 'ğŸŸ¢ BlindSpot Guardian activeâ€¦';
                        if (alertLog) alertLog.innerHTML = '';
                        intervalId = setInterval(analyzeFrame, 1500); // fast 1.5s for dashcam
                    } catch (e) {
                        if (statusEl) statusEl.textContent = 'âŒ Camera error: ' + e.message;
                    }
                }

                function stopGuardian() {
                    isRunning = false;
                    clearInterval(intervalId);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    if (video) video.srcObject = null;
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                    if (statusEl) statusEl.textContent = 'â¹ Stopped.';
                    if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                }

                async function resetTrip() {
                    stopGuardian();
                    try { await fetch('/blindspot_reset', { method: 'POST' }); } catch (_) { }
                    if (alertLog) alertLog.innerHTML = '<em style="color:var(--text-muted)">Trip reset.</em>';
                    if (alertEl) alertEl.textContent = 'CLEAR';
                    if (alertEl) alertEl.style.color = '#22c55e';
                    if (hazardEl) hazardEl.textContent = 'â€”';
                    if (totalAl) totalAl.textContent = '0';
                }

                if (btnStart) btnStart.addEventListener('click', startGuardian);
                if (btnStop) btnStop.addEventListener('click', stopGuardian);
                if (btnReset) btnReset.addEventListener('click', resetTrip);
            })();
        </script>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB 15: MEETING ASSISTANT JAVASCRIPT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            (function MeetingAssistantModule() {
                let stream = null, intervalId = null, transcriptInterval = null, isRunning = false;
                const SESSION_ID = 'meeting-' + Date.now();
                const video = document.getElementById('meetingVideo');
                const btnStart = document.getElementById('btnMeetingStart');
                const btnStop = document.getElementById('btnMeetingStop');
                const btnSumm = document.getElementById('btnMeetingSummarize');
                const btnClear = document.getElementById('btnMeetingClear');
                const statusEl = document.getElementById('meetingStatus');
                const participantEl = document.getElementById('meetingParticipants');
                const transcriptEl = document.getElementById('meetingTranscript');
                const actionsEl = document.getElementById('meetingActions');
                const decisionsEl = document.getElementById('meetingDecisions');
                const summaryEl = document.getElementById('meetingSummary');
                const durationEl = document.getElementById('meetingDuration');
                const transcriptInput = document.getElementById('meetingTranscriptInput');
                const btnAddTranscript = document.getElementById('btnAddTranscript');
                const speakerInput = document.getElementById('meetingSpeaker');

                if (!btnStart) return;

                // Speech recognition for live transcription
                let rec = null;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SR) {
                    rec = new SR();
                    rec.lang = 'en-US';
                    rec.continuous = true;
                    rec.interimResults = true;
                    rec.onresult = async (e) => {
                        for (let i = e.resultIndex; i < e.results.length; i++) {
                            if (e.results[i].isFinal) {
                                const text = e.results[i][0].transcript.trim();
                                if (text.length > 3) await submitTranscriptChunk(text, 'Speaker');
                            }
                        }
                    };
                }

                function captureFrame() {
                    if (!video || !video.srcObject) return null;
                    const c = document.createElement('canvas');
                    c.width = video.videoWidth || 640; c.height = video.videoHeight || 480;
                    c.getContext('2d').drawImage(video, 0, 0);
                    return c.toDataURL('image/jpeg', 0.6).split(',')[1];
                }

                async function pollParticipants() {
                    const fb = captureFrame();
                    if (!fb) return;
                    try {
                        const r = await fetch('/meeting_frame', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64: fb, session_id: SESSION_ID })
                        });
                        const d = await r.json();
                        if (participantEl && d.participant_count !== undefined)
                            participantEl.textContent = d.participant_count;
                    } catch (_) { }
                }

                async function submitTranscriptChunk(text, speaker) {
                    if (!text) return;
                    try {
                        const r = await fetch('/meeting_transcript_add', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text, speaker: speaker || 'Speaker', session_id: SESSION_ID })
                        });
                        const d = await r.json();
                        if (actionsEl && d.action_items && d.action_items.length) {
                            d.action_items.forEach(a => {
                                const el = document.createElement('div');
                                el.style.cssText = 'padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05)';
                                el.textContent = 'â€¢ ' + (a.task || a);
                                actionsEl.appendChild(el);
                            });
                        }
                        if (decisionsEl && d.decisions && d.decisions.length) {
                            d.decisions.forEach(dec => {
                                const el = document.createElement('div');
                                el.style.cssText = 'padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05)';
                                el.textContent = 'âœ“ ' + (dec.decision || dec);
                                decisionsEl.appendChild(el);
                            });
                        }
                        refreshTranscript();
                    } catch (_) { }
                }

                async function refreshTranscript() {
                    try {
                        const r = await fetch('/meeting_transcript?session_id=' + SESSION_ID + '&last_n=30');
                        const d = await r.json();
                        if (transcriptEl && d.transcript) {
                            transcriptEl.innerHTML = d.transcript.map(t =>
                                `<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="color:var(--accent);font-weight:600">${t.speaker || '?'}:</span> ${t.text}</div>`
                            ).join('');
                            transcriptEl.scrollTop = transcriptEl.scrollHeight;
                        }
                        if (d.session && durationEl) {
                            const mins = Math.floor((d.session.duration_seconds || 0) / 60);
                            const secs = (d.session.duration_seconds || 0) % 60;
                            durationEl.textContent = `${mins}:${String(secs).padStart(2, '0')}`;
                        }
                    } catch (_) { }
                }

                async function summarizeMeeting() {
                    if (summaryEl) summaryEl.textContent = 'Generating summaryâ€¦';
                    if (btnSumm) btnSumm.disabled = true;
                    try {
                        const r = await fetch('/meeting_summarize', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: SESSION_ID })
                        });
                        const d = await r.json();
                        if (summaryEl) {
                            summaryEl.innerHTML = `<p style="margin-bottom:8px">${d.summary || JSON.stringify(d)}</p>`;
                            if (d.key_points && d.key_points.length) {
                                summaryEl.innerHTML += `<b>Key Points:</b><ul style="margin-top:4px">${d.key_points.map(p => `<li>${p}</li>`).join('')}</ul>`;
                            }
                        }
                        VA_SPEAK('Meeting summary ready.', { rate: 0.95 });
                    } catch (e) {
                        if (summaryEl) summaryEl.textContent = 'Error: ' + e.message;
                    } finally {
                        if (btnSumm) btnSumm.disabled = false;
                    }
                }

                async function startMeeting() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        video.srcObject = stream;
                        await video.play();
                        isRunning = true;
                        btnStart.disabled = true;
                        btnStop.disabled = false;
                        if (statusEl) statusEl.textContent = 'ğŸŸ¢ Meeting in progressâ€¦';
                        if (actionsEl) actionsEl.innerHTML = '';
                        if (decisionsEl) decisionsEl.innerHTML = '';
                        if (summaryEl) summaryEl.textContent = '';
                        intervalId = setInterval(pollParticipants, 4000);
                        transcriptInterval = setInterval(refreshTranscript, 5000);
                        if (rec) rec.start();
                    } catch (e) {
                        if (statusEl) statusEl.textContent = 'âŒ Camera error: ' + e.message;
                    }
                }

                function stopMeeting() {
                    isRunning = false;
                    clearInterval(intervalId);
                    clearInterval(transcriptInterval);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    if (video) video.srcObject = null;
                    if (rec) try { rec.stop(); } catch (_) { }
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                    if (statusEl) statusEl.textContent = 'â¹ Meeting ended.';
                    refreshTranscript();
                }

                async function clearMeeting() {
                    stopMeeting();
                    try { await fetch('/meeting_clear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: SESSION_ID }) }); } catch (_) { }
                    if (transcriptEl) transcriptEl.innerHTML = '<em style="color:var(--text-muted)">Cleared.</em>';
                    if (actionsEl) actionsEl.innerHTML = '';
                    if (decisionsEl) decisionsEl.innerHTML = '';
                    if (summaryEl) summaryEl.textContent = '';
                    if (participantEl) participantEl.textContent = '0';
                }

                btnStart.addEventListener('click', startMeeting);
                btnStop.addEventListener('click', stopMeeting);
                if (btnSumm) btnSumm.addEventListener('click', summarizeMeeting);
                if (btnClear) btnClear.addEventListener('click', clearMeeting);

                // Manual transcript add
                if (btnAddTranscript) {
                    btnAddTranscript.addEventListener('click', async () => {
                        const text = transcriptInput ? transcriptInput.value.trim() : '';
                        const speaker = speakerInput ? speakerInput.value.trim() || 'You' : 'You';
                        if (!text) return;
                        await submitTranscriptChunk(text, speaker);
                        if (transcriptInput) transcriptInput.value = '';
                    });
                }
            })();
        </script>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB 16: ACCESSIBILITY AGENT JAVASCRIPT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            (function AccessibilityModule() {
                let stream = null, intervalId = null, isRunning = false;
                const video = document.getElementById('accessVideo');
                const btnStart = document.getElementById('btnAccessStart');
                const btnStop = document.getElementById('btnAccessStop');
                const statusEl = document.getElementById('accessStatus');
                const captionEl = document.getElementById('accessCaption');
                const historyEl = document.getElementById('accessHistory');
                const modeSelect = document.getElementById('accessMode');
                const intervalInput = document.getElementById('accessInterval');
                const voiceToggle = document.getElementById('accessVoiceToggle');
                const btnReadNow = document.getElementById('btnAccessReadNow');
                const counterEl = document.getElementById('accessCount');

                if (!btnStart) return;

                let voiceEnabled = true;
                let descCount = 0;
                if (voiceToggle) voiceToggle.addEventListener('change', () => { voiceEnabled = voiceToggle.checked; });

                // Mode buttons
                ['scene', 'read', 'navigate', 'identify', 'currency'].forEach(m => {
                    const btn = document.getElementById('accessMode_' + m);
                    if (btn) btn.addEventListener('click', () => {
                        // mark active
                        document.querySelectorAll('[id^="accessMode_"]').forEach(b => b.style.opacity = '0.5');
                        btn.style.opacity = '1';
                        if (modeSelect) modeSelect.value = m;
                    });
                });

                function captureFrame() {
                    if (!video || !video.srcObject) return null;
                    const c = document.createElement('canvas');
                    c.width = video.videoWidth || 640; c.height = video.videoHeight || 480;
                    c.getContext('2d').drawImage(video, 0, 0);
                    return c.toDataURL('image/jpeg', 0.65).split(',')[1];
                }

                async function describeScene(force = false) {
                    const fb = captureFrame();
                    if (!fb) return;
                    const mode = (modeSelect ? modeSelect.value : null) ||
                        document.querySelector('[id^="accessMode_"][style*="opacity: 1"]')?.id?.replace('accessMode_', '') ||
                        'scene';
                    try {
                        const r = await fetch('/accessibility_describe', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ frame_b64: fb, mode, force_refresh: force })
                        });
                        const d = await r.json();
                        if (!d.description) return;

                        descCount++;
                        if (counterEl) counterEl.textContent = descCount;

                        if (captionEl) {
                            captionEl.style.opacity = '0';
                            setTimeout(() => {
                                captionEl.textContent = d.description;
                                captionEl.style.opacity = '1';
                            }, 150);
                        }

                        // Add to history
                        if (historyEl) {
                            const entry = document.createElement('div');
                            entry.style.cssText = 'padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:13px;line-height:1.6';
                            entry.innerHTML = `<span style="color:var(--text-muted);font-size:11px">${new Date().toLocaleTimeString()} [${mode}]</span><br>${d.description}`;
                            historyEl.insertBefore(entry, historyEl.firstChild);
                            while (historyEl.children.length > 30) historyEl.removeChild(historyEl.lastChild);
                        }

                        if (voiceEnabled) {
                            VA_SPEAK(d.description, { rate: 0.9, pitch: 1.05 });
                        }
                    } catch (e) {
                        if (statusEl) statusEl.textContent = 'âš ï¸ Error: ' + e.message;
                    }
                }

                async function startAccessibility() {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
                        video.srcObject = stream;
                        await video.play();
                        isRunning = true;
                        btnStart.disabled = true;
                        btnStop.disabled = false;
                        if (statusEl) statusEl.textContent = 'ğŸŸ¢ Accessibility Agent active â€” describing sceneâ€¦';
                        const secs = intervalInput ? (parseFloat(intervalInput.value) || 5) : 5;
                        await describeScene(true);
                        intervalId = setInterval(() => describeScene(false), secs * 1000);
                        VA_SPEAK('Accessibility agent started. I will describe what I see.', { rate: 0.9 });
                    } catch (e) {
                        if (statusEl) statusEl.textContent = 'âŒ Camera error: ' + e.message;
                    }
                }

                function stopAccessibility() {
                    isRunning = false;
                    clearInterval(intervalId);
                    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
                    if (video) video.srcObject = null;
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                    if (statusEl) statusEl.textContent = 'â¹ Accessibility Agent stopped.';
                }

                btnStart.addEventListener('click', startAccessibility);
                btnStop.addEventListener('click', stopAccessibility);
                if (btnReadNow) {
                    btnReadNow.addEventListener('click', () => describeScene(true));
                }

                // Keyboard shortcut: Space = describe now (when tab active)
                document.addEventListener('keydown', e => {
                    const panel = document.getElementById('panelAccess') || document.getElementById('panelAccessibility');
                    if (!panel || !panel.style.display || panel.style.display === 'none') return;
                    if (e.key === ' ' && isRunning) { e.preventDefault(); describeScene(true); }
                });

                // Caption display transition
                if (captionEl) {
                    captionEl.style.transition = 'opacity 0.3s ease';
                }
            })();
        </script>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             COSMIC STARFIELD BACKGROUND
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <script>
            // Starfield already rendered above (see original IIFE above line 4640)
        </script>
</body>

</html>