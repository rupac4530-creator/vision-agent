name: CI — Vision Agent

on:
  push:
    branches: [submission, main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify imports
        run: |
          cd backend
          python -c "
          from fastapi import FastAPI
          from frame_extractor import extract_frames
          from transcribe import transcribe_audio_whisper
          from detect import detect_frames
          from generate_notes import generate_notes_from_analysis
          from streaming import router
          from llm_helpers import call_llm, safe_parse_json
          print('All imports OK')
          "

      - name: Start server and health check
        run: |
          cd backend
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000)
          echo "Health check: HTTP $STATUS"
          [ "$STATUS" = "200" ] || exit 1
          STATUS_DEMO=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/demo)
          echo "Demo page: HTTP $STATUS_DEMO"
          [ "$STATUS_DEMO" = "200" ] || exit 1

      - name: Verify sample outputs exist
        run: |
          test -f backend/analysis/sample/analysis.json && echo "✅ sample analysis.json"
          test -f backend/analysis/sample/notes.json && echo "✅ sample notes.json"
          test -f backend/analysis/sample/quiz.json && echo "✅ sample quiz.json"
